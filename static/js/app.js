var __rest=this&&this.__rest||function(e,t){var s={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&(s[n[o]]=e[n[o]]);return s},__awaiter=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))(function(o,i){function r(e){try{l(n.next(e))}catch(e){i(e)}}function a(e){try{l(n.throw(e))}catch(e){i(e)}}function l(e){e.done?o(e.value):new s(function(t){t(e.value)}).then(r,a)}l((n=n.apply(e,t||[])).next())})};define("ts/db/index",["require","exports"],function(e,t){"use strict";function s({oldVersion:e,target:t}){c=t.result;const s=t.transaction;let n=null,o=null;switch(e){case 0:for(const e of u)(o=c.createObjectStore(e,{keyPath:"id"})).createIndex("op","op");(o=c.createObjectStore(h,{keyPath:"url"})).createIndex("expires","expires");break;case 1:(o=c.createObjectStore(h,{keyPath:"url"})).createIndex("expires","expires");case 2:case 3:s.objectStore(h).clear();case 4:c.deleteObjectStore("seen"),c.deleteObjectStore("seenPost"),c.deleteObjectStore("hidden");const t=[],i=()=>{c.deleteObjectStore("mine"),(o=c.createObjectStore("mine",{keyPath:"id"})).createIndex("op","op");for(const[e,s]of t)o.put({id:e,op:s})};(n=s.objectStore("mine").openCursor()).onsuccess=(e=>{const s=e.target.result;s?(t.push([s.value.id,s.value.op]),s.continue()):i()});case 5:const r=[],a=()=>{localStorage.mine=JSON.stringify(r)};(n=s.objectStore("mine").openCursor()).onsuccess=(e=>{const t=e.target.result;t?(r.push(t.value.id),t.continue()):a()});case 6:s.objectStore(h).clear();case 7:s.objectStore(h).clear()}}function n(e){console.error(e)}function o(e){const t=i(e,!0).index("expires").openCursor(IDBKeyRange.upperBound(Date.now()));t.onsuccess=(e=>{const t=e.target.result;t&&(t.delete(),t.continue())}),t.onerror=n}function i(e,t){const s=c.transaction(e,t?"readwrite":"readonly");return s.onerror=n,s.objectStore(e)}function r(e,t){return d?Promise.reject(new Error("db unavailable")):new Promise((s,n)=>{const o=i(e,!1).get(t);o.onsuccess=(()=>{o.result?s(o.result):n(new Error("empty getObj result"))}),o.onerror=(()=>{n(o.error)})})}function a(e,t){d||(i(e,!0).put(t).onerror=n)}Object.defineProperty(t,"__esModule",{value:!0});const l=8;let c=null,d=!1;const u=["mine"],h="embedCache";t.init=function(){return new Promise((e,t)=>{const i=indexedDB.open("cutechan",l);i.onsuccess=(()=>{(c=i.result).onerror=n,c.onversionchange=(()=>{c.close(),location.reload(!0)}),setTimeout(()=>{o(h)},1e4),e()}),i.onupgradeneeded=s,i.onerror=(()=>{t(i.error)})}).catch(e=>{if(window.indexedDB&&"A mutation operation was attempted on a database that did not allow mutations."!==e.message)throw e;d=!0})},t.getIDs=function(e,...t){return d||!t.length?Promise.resolve([]):new Promise((s,n)=>{const o=[];t.sort((e,t)=>e-t);const r=i(e,!1).index("op").openCursor(IDBKeyRange.bound(t[0],t[t.length-1]));r.onsuccess=(e=>{const t=e.target.result;t?(o.push(t.value.id),t.continue()):s(o)}),r.onerror=(()=>{n(r.error)})})},t.setID=function(e,t,s){a(e,{id:t,op:s})},t.clearStore=function(e){d||(i(e,!0).clear().onerror=n)},t.getEmbed=function(e){return r(h,e)},t.setEmbed=function(e,t,s){const n=Date.now()+s;return a(h,Object.assign({},t,{url:e,expires:n}))}}),define("ts/util/fsm",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class s{constructor(e){this.stateHandlers=new n,this.onceHandlers=new n,this.transitions={},this.wilds={},this.state=e}on(e,t){this.stateHandlers.add(e.toString(),t)}once(e,t){this.onceHandlers.add(e.toString(),t)}act(e,t,s){this.transitions[this.transitionString(e,t)]=s}wildAct(e,t){this.wilds[e.toString()]=t}feed(e,t){let s;const n=e.toString();if(n in this.wilds)s=this.wilds[n](t);else{const n=this.transitionString(this.state,e),o=this.transitions[n];if(!o)return;s=o(t)}this.state=s;const o=s.toString();this.stateHandlers.forEach(o,e=>e(t)),this.onceHandlers.forEach(o,e=>e(t)),this.onceHandlers.removeAll(o)}feeder(e){return t=>this.feed(e,t)}transitionString(e,t){return`${e}+${t}`}}t.default=s;class n{constructor(){this.map={}}add(e,t){e in this.map||(this.map[e]=new Set),this.map[e].add(t)}remove(e,t){const s=this.map[e];s&&(s.delete(t),0===s.size&&delete this.map[e])}removeAll(e){delete this.map[e]}forEach(e,t){const s=this.map[e];s&&s.forEach(t)}}}),define("ts/util/progress",["require","exports","classnames","preact"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){var{progress:t,className:o,children:i}=e,r=__rest(e,["progress","className","children"]);t=Math.floor(t),t=Math.max(0,Math.min(t,100));const a=s("progress",o),l=`\n    linear-gradient(\n      to right,\n      #754383 ${t}%,\n      transparent ${t}%\n    )\n  `;return n.h("div",Object.assign({class:a,style:{background:l},title:`${t}%`},r),i)}}),define("ts/util/show-hide",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function({show:e,children:t}){return e?t[0]:null}}),define("ts/util/fetch",["require","exports"],function(e,t){"use strict";function s(e){const t=new FormData;for(let s of Object.keys(e)){const n=e[s];Array.isArray(n)?(s+="[]",n.forEach(e=>t.append(s,e))):"boolean"==typeof n?n&&t.append(s,"on"):t.append(s,n)}return t}function n(e){const t=new Headers,s=e.getAllResponseHeaders();for(const n of s.trim().split(/\r\n/)){const[e,s]=n.split(/: (.+)/);t.append(e,s)}return t}Object.defineProperty(t,"__esModule",{value:!0});class o extends Error{}t.AbortError=o,t.uncachedGET=function(e){return fetch(e,{credentials:"same-origin",headers:{"Cache-Control":"no-cache"},method:"GET"})},t.fetchJSON=function(e){return fetch(e).then(e=>e.ok?e.json():e.text().then(e=>{throw new Error(e)}))},t.postJSON=function(e,t){return fetch(e,{body:JSON.stringify(t),credentials:"same-origin",method:"POST"})},t.postForm=function(e,t){return fetch(e,{body:s(t),credentials:"same-origin",method:"POST"})},t.postFormProgress=function(e,t,i,r){return new Promise((a,l)=>{const c=new XMLHttpRequest;c.open("POST",e),c.onload=(()=>{const{status:e,statusText:t}=c,s={status:e,statusText:t,headers:n(c)};a(new Response(c.responseText,s))}),c.onerror=l,i&&(c.upload.onprogress=i),r&&(r.abort=(()=>{c.abort(),l(new o)})),c.send(s(t))})}}),define("ts/util/hooks",["require","exports","events"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=new s.EventEmitter;t.hook=function(e,t){n.addListener(e.toString(),t)},t.unhook=function(e,t){n.removeListener(e.toString(),t)},t.trigger=function(e,...t){n.emit(e.toString(),...t)}}),define("ts/util/render",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s={};t.importTemplate=function(e){return document.importNode(s[e],!0)};for(const n of document.head.querySelectorAll("template"))s[n.getAttribute("name")]=n.content}),define("ts/util/changes",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.emitChanges=function(e){const t={};return e.onChange=((e,s)=>{const n=t[e];n?n.push(s):t[e]=[s]}),new Proxy(e,{set:(e,s,n)=>(e[s]=n,(t[s]||[]).forEach(e=>e(n)),!0)})}}),define("ts/vars/index",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ALERTS_CONTAINER_SEL=".alerts-container",t.HOVER_CONTAINER_SEL=".hover-container",t.POPUP_CONTAINER_SEL=".popup-container",t.REPLY_CONTAINER_SEL=".reply-container",t.BOARD_SEARCH_INPUT_SEL=".board-search-input",t.BOARD_SEARCH_SORT_SEL=".board-search-sort",t.THREAD_SEL=".thread",t.POST_SEL=".post",t.POST_LINK_SEL=".post-link",t.POST_BODY_SEL=".post-body",t.POST_FILE_TITLE_SEL=".post-file-title",t.POST_FILE_LINK_SEL=".post-file-link",t.POST_FILE_THUMB_SEL=".post-file-thumb",t.POST_BACKLINKS_SEL=".post-backlinks",t.POST_EMBED_SEL=".post-embed",t.PAGE_NAV_TOP_SEL=".page-nav-top",t.PAGE_NAV_BOTTOM_SEL=".page-nav-bottom",t.TRIGGER_OPEN_REPLY_SEL=".trigger-open-reply",t.TRIGGER_QUOTE_POST_SEL=".trigger-quote-post",t.TRIGGER_DELETE_POST_SEL=".trigger-delete-post",t.TRIGGER_BAN_BY_POST_SEL=".trigger-ban-by-post",t.TRIGGER_MEDIA_HOVER_SEL=".trigger-media-hover",t.TRIGGER_MEDIA_POPUP_SEL=".trigger-media-popup",t.TRIGGER_PAGE_NAV_TOP_SEL=".trigger-page-nav-top",t.TRIGGER_PAGE_NAV_BOTTOM_SEL=".trigger-page-nav-bottom",t.ALERT_HIDE_TIMEOUT_SECS=5,t.RELATIVE_TIME_PERIOD_SECS=60,t.HOVER_TRIGGER_TIMEOUT_SECS=.1,t.POST_HOVER_TIMEOUT_SECS=.5,t.ZOOM_STEP_PX=100,t.HEADER_HEIGHT_PX=30,t.REPLY_THREAD_WIDTH_PX=700,t.REPLY_BOARD_WIDTH_PX=1e3,t.REPLY_HEIGHT_PX=200,t.DEFAULT_NOTIFICATION_IMAGE_URL="/static/img/notification.png";t.EMBED_CACHE_EXPIRY_MS=2592e6}),define("ts/util/index",["require","exports","ts/util/fsm","ts/util/progress","ts/util/show-hide","ts/util/fetch","ts/util/hooks","ts/util/render","ts/util/changes","ts/vars/index"],function(e,t,s,n,o,i,r,a,l,c){"use strict";function d(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}function u(e){return e?+e.getAttribute("data-id"):0}function h(){}Object.defineProperty(t,"__esModule",{value:!0}),t.FSM=s.default,t.Progress=n.default,t.ShowHide=o.default,d(i),d(r),d(a),d(l),t.getID=u,t.getClosestID=function(e){return e?u(e.closest(c.POST_SEL)):0},t.makeNode=function(e){const t=document.createElement("div");return t.innerHTML=e,t.firstChild},t.makeFrag=function(e){return document.createRange().createContextualFragment(e)},t.on=function(e,t,s,n){if(n&&n.selector){const e=s,t=Array.isArray(n.selector)?n.selector.join(","):n.selector;s=(s=>{const n=s.target;n instanceof Element&&n.matches(t)&&e(s)})}e.addEventListener(t,s,n)},t.pad=function(e){return(e<10?"0":"")+e};const p={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"},f={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};t.escape=function(e){return e.replace(/[&<>"']/g,e=>p[e])},t.unescape=function(e){return e.replace(/&(amp|lt|gt|quot|apos);/g,e=>f[e])},t.firstChild=function(e,t){for(const s of Array.from(e.children))if(t(s))return s;return null},t.inputElement=function(e,t){return e.querySelector(`input[name="${t}"]`)},t.extractJSON=function(e){const t=document.getElementById(e);return t?JSON.parse(t.textContent):null},t.isAtBottom=function(){const e=document.documentElement;return e.scrollHeight-e.scrollTop<=e.clientHeight+10},t.scrollToTop=function(){window.scrollTo(0,0)},t.scrollToBottom=function(){window.scrollTo(0,document.documentElement.scrollHeight)},t.copyToClipboard=function(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{document.execCommand("copy")}finally{document.body.removeChild(t)}},t.remove=function(e,t){const s=e.indexOf(t);s>=0&&e.splice(s,1)},t.noop=h,t.setter=function(e,t){return s=>{e[t]=s}},t.collect=function(e){const t=[];return e=e.map(e=>e.then(e=>t.push(e),h)),Promise.all(e).then(()=>t)},t.reverse=function(e){let t="";for(let s=e.length-1;s>=0;s--)t+=e[s];return t},t.rotateRecent=function(e,t,s){const n=e.indexOf(t);return n<0?[t,...e.slice(0,s-1)]:[t,...e.slice(0,n),...e.slice(n+1)]}}),define("ts/base/view",["require","exports","ts/util/index"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n{}t.Model=n;class o{constructor({el:e,model:t,tag:s,class:n,id:o}){if(t&&(this.model=t),e){this.el=e;const t=e.getAttribute("id");t&&(this.id=t)}else this.el=document.createElement(s||"div"),o&&(this.el.setAttribute("id",o),this.id=o),n&&this.el.setAttribute("class",n)}remove(){this.el.remove()}inputElement(e){return s.inputElement(this.el,e)}on(e,t,n){s.on(this.el,e,t,n)}onClick(e){for(const t of Object.keys(e))this.on("click",e[t],{selector:t,capture:!0})}}t.default=o}),define("ts/base/header",["require","exports","ts/base/view"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n={};let o;class i extends s.default{constructor(e){super({el:e}),n[this.id]=this,document.getElementById("header-"+this.id.split("-")[0]).addEventListener("click",()=>this.toggle(),{capture:!0})}toggle(){if(o){const e=o;o.hide(),e!==this&&this.show()}else this.show()}show(){this.el.style.display="block",o=this,this.showHook&&this.showHook()}hide(){this.el.style.display="none",o=null}}t.HeaderModal=i;class r extends i{constructor(e){super(e),this.onClick({".tab-link":e=>this.switchTab(e)})}switchTab(e){const t=e.target;for(const n of this.el.querySelectorAll(".tab-sel"))n.classList.remove("tab-sel");t.classList.add("tab-sel");const s=t.getAttribute("data-id");for(const n of this.el.querySelectorAll(`.tab-cont > div`))n.getAttribute("data-id")===s&&n.classList.add("tab-sel");this.tabHook&&this.tabHook(parseInt(s,10))}}t.TabbedModal=r}),define("ts/base/index",["require","exports","ts/base/view","ts/base/header"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=s.default,t.Model=s.Model,t.HeaderModal=n.HeaderModal,t.TabbedModal=n.TabbedModal}),define("ts/common/index",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.jpg=0]="jpg",e[e.png=1]="png",e[e.gif=2]="gif",e[e.webm=3]="webm",e[e.pdf=4]="pdf",e[e.svg=5]="svg",e[e.mp4=6]="mp4",e[e.mp3=7]="mp3",e[e.ogg=8]="ogg",e[e.zip=9]="zip",e[e["7z"]=10]="7z",e[e["tar.gz"]=11]="tar.gz",e[e["tar.xz"]=12]="tar.xz"}(t.fileTypes||(t.fileTypes={})),t.thumbSize=200}),define("ts/alerts/index",["require","exports","preact","ts/util/index","ts/vars/index"],function(e,t,s,n,o){"use strict";function i(e){"string"==typeof e?e={message:e}:e instanceof Error&&(e={message:e.message}),n.trigger(3,e)}Object.defineProperty(t,"__esModule",{value:!0});class r extends s.Component{constructor(){super(...arguments),this.state={alerts:[]},this.id=0,this.show=(e=>{const t=[e=Object.assign({},e,{id:this.id++})].concat(this.state.alerts);this.setState({alerts:t}),e.sticky||setTimeout(this.makeHide(e.id),1e3*o.ALERT_HIDE_TIMEOUT_SECS)}),this.renderAlert=(({id:e,title:t,message:n})=>s.h("div",{class:"alert",key:e.toString()},s.h("a",{class:"control alert-close-control",onClick:this.makeHide(e)},s.h("i",{class:"fa fa-remove"})),this.renderTitle(t),s.h("div",{class:"alert-message"},n)))}componentDidMount(){n.hook(3,this.show)}componentWillUnmount(){n.unhook(3,this.show)}render({},{alerts:e}){return s.h("div",{class:"alerts-container-inner"},e.map(this.renderAlert))}makeHide(e){return()=>{const t=this.state.alerts.filter(t=>t.id!==e);this.setState({alerts:t})}}renderTitle(e){return e?s.h("div",{class:"alert-title"},e):null}}t.show=i,t.showAlert=i,t.init=function(){const e=document.querySelector(o.ALERTS_CONTAINER_SEL);e&&s.render(s.h(r,null),e)}}),define("ts/ui/captcha",["require","exports","ts/alerts/index","ts/base/index","ts/util/index"],function(e,t,s,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i extends n.View{constructor(e){super({el:e});const t=this.el.querySelector("noscript");t&&t.remove(),this.input=this.el.querySelector(`input[name="captcha"]`),this.render().catch(e=>{throw s.showAlert(e.message),e})}data(){return this.input?{captchaID:this.captchaID,solution:this.input.value}:{}}reload(){this.input.value="",this.render()}render(){return __awaiter(this,void 0,void 0,function*(){const e=yield o.uncachedGET(`/api/captcha/new`),t=yield e.text();if(200!==e.status)throw t;this.captchaID=t,this.el.querySelector("img").setAttribute("src",`/api/captcha/image/${this.captchaID}.png`);const s=this.inputElement("captchaID");s.hidden=!0,s.value=this.captchaID})}}t.default=i}),define("ts/ui/forms",["require","exports","ts/base/index","ts/util/index","ts/ui/captcha"],function(e,t,s,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i extends s.View{constructor(e){super(e),this.onClick({".array-add":e=>this.addInput(e,"arrayItem"),".map-add":e=>this.addInput(e,"keyValue"),".map-remove, .array-remove":e=>this.removeInput(e),"input[name=cancel]":()=>this.remove()}),this.on("submit",e=>this.submit(e)),this.lazyCaptcha=e.lazyCaptcha,e.lazyCaptcha||this.initCaptcha()}initCaptcha(){const e=this.el.querySelector(".captcha-container");e&&(e.querySelector("img").removeAttribute("src"),e.querySelector(`input[name="captcha"]`).value="",this.captcha=new o.default(e))}remove(){this.captcha&&this.captcha.remove(),super.remove()}reloadCaptcha(){this.captcha?this.captcha.reload():this.lazyCaptcha&&this.initCaptcha()}injectCaptcha(e){this.captcha&&Object.assign(e,this.captcha.data())}renderFormResponse(e){this.el.querySelector(".form-response").textContent=e,this.reloadCaptcha()}submit(e){e.preventDefault(),this.send()}addInput(e,t){e.target.before(n.importTemplate(t))}removeInput(e){e.target.closest("span").remove()}}t.default=i}),define("ts/connection/messages",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handlers={}}),define("ts/lang/index",["require","exports","cc-langs"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=window.config.defaultLang,o=s.default[n];t.lang={Plurals:o.common.plurals,Posts:o.common.posts,Sizes:o.common.sizes,UI:o.common.ui,plurals:o.common.plurals,posts:o.common.posts,time:o.common.time,ui:o.common.ui},t.ln={Forms:o.forms,UI:o.ui,Common:t.lang},t.default=t.lang,t.printf=function(e,...t){return e.replace(/%s/,()=>t.shift())}}),define("ts/api/index",["require","exports","ts/lang/index","ts/util/index"],function(e,t,s,n){"use strict";function o(e){return e.headers.get("Content-Type").startsWith("application/json")?e.json().then(e=>{throw new Error(e.message||s.ln.UI.unknownErr)}):e.text().then(e=>{const t=e.slice(0,200);throw new Error(t)})}function i(e,t,n){return n=`/api/${n}`,(t,i,r)=>e(n,t,i,r).then(e=>e.ok?e.json().catch(()=>{throw new Error(s.ln.UI.unknownErr)}):o(e),e=>{throw e.message=e.message||s.ln.UI.networkErr,e})}Object.defineProperty(t,"__esModule",{value:!0});const r={GET:{JSON:i.bind(null,n.uncachedGET,"GET")},POST:{Form:i.bind(null,n.postFormProgress,"POST"),JSON:i.bind(null,n.postJSON,"POST")}};t.API={post:{create:r.POST.Form("post"),createToken:r.POST.JSON("post/token"),delete:r.POST.JSON("delete-post"),get:e=>r.GET.JSON(`post/${e}`)()},thread:{create:r.POST.Form("thread")},user:{banByPost:r.POST.JSON("ban")}},t.default=t.API}),define("ts/client/index",["require","exports","ts/alerts/index","ts/connection/index","ts/options/index","ts/posts/index","ts/state/index","ts/ui/index","ts/util/index"],function(e,t,s,n,o,i,r,a,l){"use strict";function c(e,t){const s=r.posts.get(e);s&&t(s)}function d(e){const t=l.isAtBottom(),s=new i.Post(e);s.op=r.page.thread,s.board=r.page.board,r.posts.add(s);const n=new i.PostView(s,null);n.afterRender(),s.propagateLinks(),document.getElementById("thread-container").firstChild.lastElementChild.after(n.el),a.postAdded(s),o.default.scrollToBottom&&t&&!i.isHoverActive()&&l.scrollToBottom()}Object.defineProperty(t,"__esModule",{value:!0}),t.insertPost=d,t.init=function(){n.handlers[0]=(e=>{throw s.showAlert(e),n.connSM.feed(4),new Error(e)}),n.handlers[2]=d,n.handlers[10]=(e=>c(e,e=>e.setDeleted())),n.handlers[37]=(e=>{location.href=`/${e}/`})}}),define("ts/connection/synchronization",["require","exports","ts/alerts/index","ts/api/index","ts/client/index","ts/state/index","ts/connection/messages","ts/connection/state"],function(e,t,s,n,o,i,r,a){"use strict";function l(e){return __awaiter(this,void 0,void 0,function*(){o.insertPost(yield n.default.post.get(e)),i.posts.get(e).view.reposition()})}Object.defineProperty(t,"__esModule",{value:!0}),t.synchronise=function(){a.send(30,{board:i.page.board,thread:i.page.thread})},r.handlers[30]=(e=>__awaiter(this,void 0,void 0,function*(){let t=0;if(i.page.lastN){t=1/0;for(const{id:e}of i.posts)e<t&&e!==i.page.thread&&(t=e);t===1/0&&(t=i.page.thread)}if(e){const{recent:n,deleted:o}=e,r=[];for(const e of n)e>=t&&!i.posts.has(e)&&r.push(l(e).catch(()=>{}));for(const e of o){const t=i.posts.get(e);t&&!t.deleted&&t.setDeleted()}yield Promise.all(r).catch(e=>{throw s.showAlert(e.message),e})}a.connSM.feed(5)}))}),define("ts/connection/ui",["require","exports","ts/connection/messages"],function(e,t,s){"use strict";function n(e){switch(e){case 3:return"fa-link";case 4:return"fa-unlink";default:return"fa-spinner fa-pulse fa-fw"}}function o(e){}Object.defineProperty(t,"__esModule",{value:!0});const i=document.getElementById("sync-status");t.renderStatus=function(e){const t=n(e);i.innerHTML=`<i class="fa ${t}"></i>`},t.renderSyncCount=o,s.handlers[35]=o}),define("ts/connection/state",["require","exports","ts/util/index","ts/connection/messages","ts/connection/synchronization","ts/connection/ui"],function(e,t,s,n,o,i){"use strict";function r(){a(),"file:"!==window.location.protocol?((m=new WebSocket(f)).onopen=t.connSM.feeder(1),m.onclose=t.connSM.feeder(2),m.onerror=t.connSM.feeder(2),m.onmessage=(({data:e})=>{d(e,!1)})):console.error("Page downloaded locally. Refusing to sync.")}function a(){m&&(m.onclose=m.onmessage=m.onopen=m.onclose=m.onerror=m=null)}function l(e,t){if(1!==m.readyState)return void console.warn("Attempting to send while socket closed");let s=c(e);null!==t&&(s+=JSON.stringify(t)),m.send(s)}function c(e){let t=e.toString();return 1===t.length&&(t="0"+t),t}function d(e,t){const s=parseInt(e.slice(0,2),10);if(33===s){for(const t of e.slice(2).split("\0"))d(t,!0);return}const o=n.handlers[s];o&&o(JSON.parse(e.slice(2)))}function u(){a(),A&&(clearTimeout(A),A=0)}function h(){if(navigator.onLine)switch(t.connSM.state){case 3:l(34,null);break;case 6:break;default:t.connSM.feed(3)}}function p(){A&&(clearTimeout(A),A=0),g=0}Object.defineProperty(t,"__esModule",{value:!0});const f=("https:"===location.protocol?"wss":"ws")+`://${location.host}/api/socket`;let m,g,A;t.connSM=new s.FSM(0),t.send=l,t.init=function(){t.connSM.feed(0)},t.connSM.act(0,0,()=>(i.renderStatus(1),g=0,r(),1));for(const b of[1,4])t.connSM.act(b,1,function(){return i.renderStatus(1),o.synchronise(),A=setTimeout(p,1e4),2});t.connSM.act(2,5,()=>(i.renderStatus(3),3)),t.connSM.wildAct(2,e=>{u(),i.renderStatus(0);const s=500*Math.pow(1.5,Math.min(Math.floor(++g/2),12));return setTimeout(t.connSM.feeder(3),s),5}),t.connSM.act(5,3,()=>navigator.onLine?(r(),setTimeout(()=>{4===t.connSM.state&&i.renderStatus(1)},100),4):5),t.connSM.wildAct(4,()=>(i.renderStatus(4),u(),6)),document.addEventListener("visibilitychange",e=>{e.target.hidden||h()}),window.addEventListener("online",()=>{p(),t.connSM.feed(3)}),window.addEventListener("offline",t.connSM.feeder(2))}),define("ts/connection/index",["require","exports","ts/connection/state","ts/connection/messages","ts/connection/synchronization","ts/connection/ui"],function(e,t,s,n,o,i){"use strict";function r(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),r(s),r(n),r(o),r(i)}),define("ts/ui/tab",["require","exports","ts/connection/index","ts/state/index"],function(e,t,s,n){"use strict";function o(){for(const e of f)e.seen()||(g+=1);f=[],r()}function i(){g=0,A=!1,b=!1;for(const e of n.posts)e.seen()||(g+=1,e.isReply()&&(A=!0));r()}function r(){let e="",t=0;6===s.connSM.state?(e="--- ",t=2):5===s.connSM.state?(e="--- ",t=1):(g&&(e=`(${g}) `,t=3),A&&(e=">> "+e,t=4)),a(e,t)}function a(e,t){if(m.state===t&&m.unseenPosts===g)return;m.unseenPosts=g,m.state=t,document.title=e+p;let s=h;switch(t){case 0:s+="default.ico";break;case 3:s+="unread.ico";break;case 4:s+="reply.ico";break;case 2:s+="error.ico";break;case 1:s=d}u.setAttribute("href",s)}function l(){setTimeout(()=>{5!==s.connSM.state&&6!==s.connSM.state||r()},5e3)}function c(){b||document.hidden||(b=!0,setTimeout(i,200))}Object.defineProperty(t,"__esModule",{value:!0});const d="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAACMuAAAjLgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL0AAAC9CgAAvQoAAL0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL0AAAC9BQAAva0AAL2tAAC9BQAAvQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL0AAAC9BQAAvakAALz/AAC8/wAAvakAAL0FAAC9AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL0AAAC9BQAAvakAALz/AADG/wAAxv8AALz/AAC9qQAAvQUAAL0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAL0AAAC9BQAAvakAALz/AADF/wAA1v8AANb/AADF/wAAvP8AAL2pAAC9BQAAvQAAAAAAAAAAAAAAAAAAAL0AAAC9BQAAvakAALz/AADF/wAA1v8AANb/AADW/wAA1v8AAMX/AAC8/wAAvakAAL0FAAC9AAAAAAAAAL0AAAC9BQAAvakAALz/AADF/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAAxf8AALz/AAC9qQAAvQUAAL0AAAC9BQAAvagAALz/AADF/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADF/wAAvP8AAL2oAAC9BQAAvVgAALz/AADF/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AAMX/AAC8/wAAvVgAALueAADF/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAAxf8AALueAADI3wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1v8AANb/AADI3wAA1rIAANb/AADW/wAA1v8AANb/AADW/wAA1v8AANalAADWpQAA1v8AANb/AADW/wAA1v8AANb/AADW/wAA1rIAANYGAADWqAAA1v8AANb/AADW/wAA1v8AANapAADWBAAA1gQAANapAADW/wAA1v8AANb/AADW/wAA1qgAANYGAADWAAAA1gUAANapAADW/wAA1v8AANapAADWBQAA1gAAANYAAADWBQAA1qkAANb/AADW/wAA1qkAANYFAADWAAAAAAAAANYAAADWBQAA1q0AANatAADWBQAA1gAAAAAAAAAAAAAA1gAAANYFAADWrQAA1q0AANYFAADWAAAAAAAAAAAAAAAAAAAA1gAAANYKAADWCgAA1gAAAAAAAAAAAAAAAAAAAAAAAADWAAAA1goAANYKAADWAAAAAAAAAAAA/n8AAPw/AAD4HwAA8A8AAOAHAADAAwAAgAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIGBAADDwwAA5+cAAA==",u=document.getElementById("favicon"),h="/static/favicons/",p=document.title;let f=[];const m={state:0,unseenPosts:0};let g=0,A=!1,b=!1;t.postAdded=function(e){f.length||setTimeout(o,16),f.push(e)},t.repliedToMe=function(e){e.seen()||(A=!0,r())},t.init=function(){s.connSM.on(3,r),s.connSM.on(5,l),s.connSM.on(6,l),document.addEventListener("scroll",c,{passive:!0}),document.addEventListener("visibilitychange",c)}}),define("ts/ui/notification",["require","exports","ts/base/index","ts/lang/index","ts/options/index","ts/state/index","ts/util/index","ts/vars/index","ts/ui/tab"],function(e,t,s,n,o,i,r,a,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if(i.mine.has(e.id))return;if(e.seen())return;if(l.repliedToMe(e),!o.default.notification||"function"!=typeof Notification||"granted"!==Notification.permission)return;let t="";o.default.workModeToggle||(t=e.files?e.getFileByIndex(0).thumb:a.DEFAULT_NOTIFICATION_IMAGE_URL);const s=new Notification(n.default.ui.quoted,{body:e.body,icon:t,vibrate:!0});s.onclick=(()=>{s.close(),window.focus(),location.hash="#"+e.id})};class c extends s.View{constructor(e){super({el:r.importTemplate("notification").firstChild}),this.on("click",()=>this.remove()),this.el.querySelector("b").textContent=e}}t.OverlayNotification=c}),define("ts/ui/keyboard",["require","exports","ts/options/index","ts/state/index","ts/util/index","ts/vars/index"],function(e,t,s,n,o,i){"use strict";function r(e){let t=!1;const n=e.altKey||e.metaKey||e.ctrlKey||e.shiftKey,i="selectionStart"in e.target;if(n){if(e.altKey)switch(e.which){case s.default.newPost:t=!0,o.trigger(0);break;case s.default.cancelPost:t=!0,o.trigger(1);break;case s.default.selectFile:t=!0,o.trigger(5);break;case s.default.previewPost:t=!0,o.trigger(6);break;case s.default.bold:t=!0,o.trigger(7);break;case s.default.italic:t=!0,o.trigger(8);break;case s.default.spoiler:t=!0,o.trigger(9);break;case s.default.workMode:t=!0,s.default.workModeToggle=!s.default.workModeToggle;break;case 38:t=!0,a()}else if(e.ctrlKey)switch(e.key){case"Enter":t=!0,o.trigger(2)}}else if(!i)switch(e.key){case"ArrowLeft":t=!0,l(!0);break;case"ArrowRight":t=!0,l(!1)}t&&(e.stopImmediatePropagation(),e.preventDefault())}function a(){n.page.thread?location.href="/all/":"all"!==n.page.board?location.href="/all/":location.href="/"}function l(e){const t=Array.from(document.querySelectorAll(i.POST_SEL));if(t.length<2)return;const s=location.hash.slice(1);let n=document.getElementById("post"+s)||(e?t[t.length-1]:t[0]),r=t.indexOf(n);for(;n;)if(r+=e?-1:1,(n=t[r])&&"none"!==getComputedStyle(n).display){location.hash="#"+o.getID(n);break}}Object.defineProperty(t,"__esModule",{value:!0}),t.init=function(){document.addEventListener("keydown",r)}}),define("ts/ui/nav",["require","exports","ts/util/index","ts/vars/index"],function(e,t,s,n){"use strict";function o(){const e=document.documentElement,t=e.scrollTop>300,s=e.scrollHeight-e.scrollTop>e.clientHeight+300;i.style.display=t?"":"none",r.style.display=s?"":"none",i.classList.toggle("page-nav-item_active",t),r.classList.toggle("page-nav-item_active",s)}Object.defineProperty(t,"__esModule",{value:!0});let i=null,r=null;t.init=function(){i=document.querySelector(n.PAGE_NAV_TOP_SEL),r=document.querySelector(n.PAGE_NAV_BOTTOM_SEL),i&&r&&(document.addEventListener("scroll",o,{passive:!0}),s.on(document,"click",s.scrollToTop,{selector:n.TRIGGER_PAGE_NAV_TOP_SEL}),s.on(document,"click",s.scrollToBottom,{selector:n.TRIGGER_PAGE_NAV_BOTTOM_SEL}),o())}}),define("ts/ui/options",["require","exports","ts/base/index","ts/options/index","ts/util/index"],function(e,t,s,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i extends s.TabbedModal{constructor(){super(document.getElementById("options")),t.panel=this,this.on("change",e=>this.applyChange(e)),this.assignValues(),o.hook("renderOptionValue",this.assignValue.bind(this))}assignValues(){for(const e of Object.keys(n.models)){const t=n.models[e],s=t.get();this.assignValue(e,t.spec.type,s)}}assignValue(e,t,s){const n=document.getElementById(e);if(n)switch(t){case 0:n.checked=s;break;case 1:case 4:case 5:n.value=s||"";break;case 3:n.value=String.fromCodePoint(s).toUpperCase()}}applyChange(e){const t=e.target,s=t.getAttribute("id"),o=n.models[s];if(!o)return;let i;switch(o.spec.type){case 0:i=t.checked;break;case 1:i=parseInt(t.value,10);break;case 4:case 5:i=t.value;break;case 3:i=t.value.toUpperCase().codePointAt(0)}o.validate(i)?n.default[s]=i:t.value=""}}t.default=i}),define("ts/ui/index",["require","exports","ts/ui/forms","ts/ui/tab","ts/ui/notification","ts/ui/captcha","ts/base/index","ts/ui/keyboard","ts/ui/nav","ts/ui/options","ts/ui/tab"],function(e,t,s,n,o,i,r,a,l,c,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.FormView=s.default,t.postAdded=n.postAdded,t.notifyAboutReply=o.default,t.OverlayNotification=o.OverlayNotification,t.CaptchaView=i.default,t.init=function(){a.init(),d.init(),l.init(),new c.default,new r.HeaderModal(document.getElementById("FAQ"))}}),define("ts/posts/collection",["require","exports","ts/base/index"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class n extends s.Model{constructor(){super(),this.models={}}has(e){return e in this.models}get(e){return this.models[e]}add(e){e.collection=this,this.models[e.id]=e}remove(e){delete e.collection,delete this.models[e.id]}removeThread(e){for(const t of this)t.op===e.id&&this.remove(t)}clear(){for(const e of this)delete e.collection;this.models={}}all(){return Object.keys(this.models).map(e=>this.models[e])}*[Symbol.iterator](){yield*this.all()}}t.default=n}),define("ts/posts/images",["require","exports","ts/common/index","ts/state/index"],function(e,t,s,n){"use strict";function o(){return n.config.imageRootOverride||"/uploads"}Object.defineProperty(t,"__esModule",{value:!0}),t.thumbPath=function(e,t){return`${o()}/thumb/${t.slice(0,2)}/${t.slice(2)}.${s.fileTypes[e]}`},t.sourcePath=function(e,t){return`${o()}/src/${t.slice(0,2)}/${t.slice(2)}.${s.fileTypes[e]}`}}),define("ts/templates/isomorph",["require","exports","cc-templates","mustache","ts/templates/index","ts/lang/index","ts/posts/index","ts/state/index","ts/util/index"],function(e,t,s,n,o,i,r,a,l){"use strict";function c(e){return new f("post-file",{SHA1:e.SHA1,HasTitle:!!e.title,LCopy:i.ln.Common.Posts.clickToCopy,Title:e.title,HasVideo:e.video,HasAudio:e.audio,HasLength:e.video||e.audio,Length:u(e.length||0),Record:e.audio&&!e.video,Size:h(e.size),Width:e.dims[0],Height:e.dims[1],TWidth:e.dims[2],THeight:e.dims[3],SourcePath:r.sourcePath(e.fileType,e.SHA1),ThumbPath:r.thumbPath(e.thumbType,e.SHA1)}).render()}function d(e,t){return t[(m[a.config.defaultLang]||m.default)(e)]}function u(e){return l.pad(Math.floor(e/60))+":"+l.pad(Math.floor(e%60))}function h(e){const t=i.ln.Common.Sizes;return e<1024?e+t.b:e<1048576?(e/1024).toFixed(2)+t.kb:(e/1024/1024).toFixed(2)+t.mb}function p(e,t,s){const n=`${e} ${d(e,t)}`;return s?`${i.ln.Common.Posts.in} ${n}`:`${n} ${i.ln.Common.Posts.ago}`}Object.defineProperty(t,"__esModule",{value:!0});class f{constructor(e,t){this.template=s.default[e],this.ctx=t}render(){return n.render(this.template,this.ctx)}renderNode(){return l.makeNode(this.render())}}t.TemplateContext=f,t.makePostContext=function(e,t,s,n,r){const a={ID:t.id,TID:e.id,Index:n,OP:e.id===t.id,Badge:e.id===t.id&&n&&r,Board:t.board,Subject:t.subject,Staff:!!t.auth,Auth:i.ln.Common.Posts[t.auth],HasFiles:!!t.files,post:t,backlinks:s};return a.PostClass=(()=>{const e=["post"];a.OP&&e.push("post_op"),a.post.files&&(e.push("post_file"),a.post.files.length>1&&e.push("post_files"));for(const t of Object.keys(o.bodyEmbeds))if(o.bodyEmbeds[t].test(a.post.body)){e.push("post_embed");break}return e.join(" ")}),a.URL=(()=>{let e="";return a.OP||(e=`#${a.ID}`),a.Index&&(e=`/${a.Board}/${a.TID}${e}`),e}),a.Time="",a.Files=(t.files||[]).map(c),a.Body=o.renderBody(t),a.Backlinks="",new f("post",a)};const m={default:e=>1===e?0:1,ru:e=>e%10==1&&e%100!=11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2};t.pluralize=d,t.readableTime=function(e){const t=new Date(1e3*e);return`${l.pad(t.getDate())} ${i.lang.time.calendar[t.getMonth()]} `+`${t.getFullYear()} (${i.lang.time.week[t.getDay()]}) `+`${l.pad(t.getHours())}:${l.pad(t.getMinutes())}`},t.duration=u,t.fileSize=h,t.renderPostLink=function(e,t,s){const n=`${t||s?`/all/${e}`:""}#${e}`;return new f("post-link",{Cross:t,ID:e,LYou:i.ln.Common.Posts.you,Mine:a.mine.has(e),URL:n}).render()},t.relativeTime=function(e){const t=Math.floor(Date.now()/1e3);let s=Math.floor((t-e)/60),n=!1;if(s<1){if(s>-5)return i.ln.Common.Posts.justNow;n=!0,s=-s}const o=[60,24,30,12],r=["minute","hour","day","month"];for(let a=0;a<o.length;a++){if(s<o[a])return p(s,i.ln.Common.Plurals[r[a]],n);s=Math.floor(s/o[a])}return p(s,i.ln.Common.Plurals.year,n)}}),define("smiles-pp/smiles",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=new Set(["arin_cute","arin_lol","arin_plsno","arin_smile","arin_susp","asuka_sad","autism","beast","bin_feels","bin_happy","bin_sad","bin_smile","bin_supersad","blinchick","bomi","bona_cute","bona_disgust","cha_angry","cha_disapp","cha_drink","cha_fing","cha_hnng","cha_satisfied","cha_smile","cha_sulk","cha_whine","cha_wtf","chen_lol","chen_smile","chen_sulk","chips","choaoa_cry","choaoa_smile","choaoa_susp","choaoa_wut","chungha_lol","coffee","cola","cool","dahyun_angry","dahyun_scream","dana_sad","doyeon_lol","elk_lol","eunbin_sulk","eunbin_wut","eunha_wut","euns_angry","euns_cute","euns_dead","euns_lol","exy_tired","frukt","goose","gun","gun2","hani_sad","heart","heart2","heart3","heart4","heechul","hug","hyejeong_wut","hyeri_cute","hyperlol","hyuna_lol","hyunsuk","hyunyoung_wut","ir_palm","ir_wut","jane_sad","jennie_disgust","jim_smile","jisoo_drink","jisoo_wut","jooe_wut","joy_lol","jyp","jyp2","karandash","kei_wut","kiki_angry","knife","kwangsoo","kyul_grr","kyul_sad","kyul_scream","kyul_smile","kyul_susp","kyul_vom","kyungri_smile","lookup","luda_angry","luda_boring","luda_lol","luda_sulk","meiqi_sad","mijoo_boring","mijoo_cool","mijoo_sulk","mimi","mimi_smile","mina_lol","minaoa","minaoa_sad","minaoa_wut","nancy_disgust","nancy_happy","nancy_lewdsmile","nancy_lol","nancy_sad","nancy_smile","nancy_sulk","nancy_susp","nancy_wut","nay_aga","nay_blin","nay_cool","nay_lol","nay_nice","nay_scream","nay_smile","nay_stone","nay_susp","nogoose","nunu_angry","nunu_boring","nunu_cry","nunu_grr","nunu_heart","nunu_lol","nunu_palm","nunu_sad","nunu_smart","nunu_stop","nunu_teehee","nunu_think","nunu_think2","nunu_ulu","nunu_wut2","orly","ovsyanka","plsno","police","priunil","ramyun","rena_angry","rena_shh","roa_boring","roa_cry","roa_disgust","roa_disgust2","roa_ew","roa_grr","roa_hey","roa_pray","roa_shh","roa_smile","roa_spy","roa_why","sana_dumb","sana_pray","sej_angry","sekshie","seol_smug","seul_boring","seul_cute","seul_disgust","seul_fear","seul_games","seul_lol","seul_pain","seul_shh","seul_welp","seul_yessir","shinhye_cry","shy","soh_lol","soh_think","soju","som_angry","som_why","som_wtf","sooman","sulli_smile","tae","tae_disgust","tae_smile","tae_welp","tae_wut","tellmemore","v_gugudalnik","wend_hmm","wendy_scream","woohee_why","xi_cool","xi_notgood","xi_scream","yeha_nice","yeha_sulk","yein_boring","yein_cry","yein_sad","yein_smart","yein_smile","yein_smilewink","yein_wut","yein_wut2","yeonwoo_angry","yeonwoo_boring","yeonwoo_cry","yeonwoo_lol","yeonwoo_sad","yeonwoo_smile","yeonwoo_sulk","yeonwoo_think","yeonwoo_tired","yeonwoo_why","yeonwoo_wut","yeri_angry","yoona","yoona_cry","yuji_bday","yuji_cool","yuji_happy","yuju","yuju_lol","yuju_smart","yuna_sad","yura_wut"])}),define("ts/templates/marked",["require","exports","smiles-pp/smiles"],function(e,t,s){"use strict";function n(e){this.tokens=[],this.tokens.links={},this.options=e||h.defaults,this.rules=p.normal,this.options.gfm&&(this.options.tables?this.rules=p.tables:this.rules=p.gfm)}function o(e,t){if(this.options=t||h.defaults,this.links=e,this.rules=f.normal,this.renderer=this.options.renderer||new i,this.renderer.options=this.options,!this.links)throw new Error("Tokens array requires a `links` property.");this.options.gfm?this.options.breaks?this.rules=f.breaks:this.rules=f.gfm:this.options.pedantic&&(this.rules=f.pedantic)}function i(e){this.options=e||{}}function r(e){this.tokens=[],this.token=null,this.options=e||h.defaults,this.options.renderer=this.options.renderer||new i,this.renderer=this.options.renderer,this.renderer.options=this.options}function a(e,t){return e.replace(t?/&/g:/&(?!#?\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function l(e){return e.replace(/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/g,function(e,t){return"colon"===(t=t.toLowerCase())?":":"#"===t.charAt(0)?"x"===t.charAt(1)?String.fromCharCode(parseInt(t.substring(2),16)):String.fromCharCode(+t.substring(1)):""})}function c(e,t){return e=e.source,t=t||"",function s(n,o){return n?(o=o.source||o,o=o.replace(/(^|[^\[])\^/g,"$1"),e=e.replace(n,o),s):new RegExp(e,t)}}function d(){}function u(e){for(var t,s,n=1;n<arguments.length;n++){t=arguments[n];for(s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e}function h(e,t,s){if(s||"function"==typeof t){s||(s=t,t=null);var o,i,l=(t=u({},h.defaults,t||{})).highlight,c=0;try{o=n.lex(e,t)}catch(e){return s(e)}i=o.length;var d=function(e){if(e)return t.highlight=l,s(e);var n;try{n=r.parse(o,t)}catch(t){e=t}return t.highlight=l,e?s(e):s(null,n)};if(!l||l.length<3)return d();if(delete t.highlight,!i)return d();for(;c<o.length;c++)!function(e){"code"!==e.type?--i||d():l(e.text,e.lang,function(t,s){return t?d(t):null==s||s===e.text?--i||d():(e.text=s,e.escaped=!0,void(--i||d()))})}(o[c])}else try{return t&&(t=u({},h.defaults,t)),r.parse(n.lex(e,t),t)}catch(e){if(e.message+="\nPlease report this to https://github.com/chjj/marked.",(t||h.defaults).silent)return"<p>An error occured:</p><pre>"+a(e.message+"",!0)+"</pre>";throw e}}Object.defineProperty(t,"__esModule",{value:!0});var p={newline:/^\n+/,code:/^( {4}[^\n]+\n*)+/,fences:d,hr:/^( *[-*_]){3,} *(?:\n+|$)/,heading:/^ *(#{1,6}) *([^\n]+?) *#* *(?:\n+|$)/,nptable:d,lheading:/^([^\n]+)\n *(=|-){2,} *(?:\n+|$)/,blockquote:/^( *>[^>\n][^\n]*)/,list:/^( *)(bull) [\s\S]+?(?:hr|def|\n{2,}(?! )(?!\1bull )\n*|\s*$)/,html:/^ *(?:comment *(?:\n|\s*$)|closed *(?:\n{2,}|\s*$)|closing *(?:\n{2,}|\s*$))/,def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +["(]([^\n]+)[")])? *(?:\n+|$)/,table:d,paragraph:/^((?:[^\n]+?(?!hr|heading|lheading|blockquote|tag|def))+)/,text:/^[^\n]+/};p.bullet=/\*/,p.item=/^( *)(bull) [^\n]*(?:\n(?!\1bull )[^\n]*)*/,p.item=c(p.item,"gm")(/bull/g,p.bullet)(),p.list=c(p.list)(/bull/g,p.bullet)("hr","\\n+(?=\\1?(?:[-*_] *){3,}(?:\\n+|$))")("def","\\n+(?="+p.def.source+")")(),p.blockquote=c(p.blockquote)("def",p.def)(),p._tag="(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:/|[^\\w\\s@]*@)\\b",p.html=c(p.html)("comment",/<!--[\s\S]*?-->/)("closed",/<(tag)[\s\S]+?<\/\1>/)("closing",/<tag(?:"[^"]*"|'[^']*'|[^'">])*?>/)(/tag/g,p._tag)(),p.paragraph=c(p.paragraph)("hr",p.hr)("heading",p.heading)("lheading",p.lheading)("blockquote",p.blockquote)("tag","<"+p._tag)("def",p.def)(),p.normal=u({},p),p.gfm=u({},p.normal,{fences:/^ *(`{3,}|~{3,})[ \.]*(\S+)? *\n([\s\S]*?)\s*\1 *(?:\n+|$)/,paragraph:/^/,heading:/^ *(#{1,6}) +([^\n]+?) *#* *(?:\n+|$)/}),p.gfm.paragraph=c(p.paragraph)("(?!","(?!"+p.gfm.fences.source.replace("\\1","\\2")+"|"+p.list.source.replace("\\1","\\3")+"|")(),p.tables=u({},p.gfm,{nptable:/^ *(\S.*\|.*)\n *([-:]+ *\|[-| :]*)\n((?:.*\|.*(?:\n|$))*)\n*/,table:/^ *\|(.+)\n *\|( *[-:]+[-| :]*)\n((?: *\|.*(?:\n|$))*)\n*/}),n.rules=p,n.lex=function(e,t){return new n(t).lex(e)},n.prototype.lex=function(e){return e=e.replace(/\r\n|\r/g,"\n").replace(/\t/g,"    ").replace(/\u00a0/g," ").replace(/\u2424/g,"\n"),this.token(e,!0)},n.prototype.token=function(e,t,s){for(var n,o,i,r,a,l,c,d,u,e=e.replace(/^ +$/gm,"");e;)if((i=this.rules.newline.exec(e))&&(e=e.substring(i[0].length),i[0].length>1&&this.tokens.push({type:"space"})),i=this.rules.code.exec(e))e=e.substring(i[0].length),i=i[0].replace(/^ {4}/gm,""),this.tokens.push({type:"code",text:this.options.pedantic?i:i.replace(/\n+$/,"")});else if(i=this.rules.fences.exec(e))e=e.substring(i[0].length),this.tokens.push({type:"code",lang:i[2],text:i[3]||""});else if(i=this.rules.heading.exec(e))e=e.substring(i[0].length),this.tokens.push({type:"heading",depth:i[1].length,text:i[2]});else if(t&&(i=this.rules.nptable.exec(e))){for(e=e.substring(i[0].length),l={type:"table",header:i[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:i[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:i[3].replace(/\n$/,"").split("\n")},d=0;d<l.align.length;d++)/^ *-+: *$/.test(l.align[d])?l.align[d]="right":/^ *:-+: *$/.test(l.align[d])?l.align[d]="center":/^ *:-+ *$/.test(l.align[d])?l.align[d]="left":l.align[d]=null;for(d=0;d<l.cells.length;d++)l.cells[d]=l.cells[d].split(/ *\| */);this.tokens.push(l)}else if(i=this.rules.lheading.exec(e))e=e.substring(i[0].length),this.tokens.push({type:"heading",depth:"="===i[2]?1:2,text:i[1]});else if(i=this.rules.hr.exec(e))e=e.substring(i[0].length),this.tokens.push({type:"hr"});else if(i=this.rules.blockquote.exec(e))e=e.substring(i[0].length),this.tokens.push({type:"blockquote_start"}),i=i[0].replace(/^ *> ?/gm,""),this.token(i,t,!0),this.tokens.push({type:"blockquote_end"});else if(i=this.rules.list.exec(e)){for(e=e.substring(i[0].length),r=i[2],this.tokens.push({type:"list_start",ordered:r.length>1}),n=!1,u=(i=i[0].match(this.rules.item)).length,d=0;d<u;d++)c=(l=i[d]).length,~(l=l.replace(/^ *([*+-]|\d+\.) +/,"")).indexOf("\n ")&&(c-=l.length,l=this.options.pedantic?l.replace(/^ {1,4}/gm,""):l.replace(new RegExp("^ {1,"+c+"}","gm"),"")),this.options.smartLists&&d!==u-1&&(r===(a=p.bullet.exec(i[d+1])[0])||r.length>1&&a.length>1||(e=i.slice(d+1).join("\n")+e,d=u-1)),o=!0,d!==u-1&&(n="\n"===l.charAt(l.length-1),o||(o=n)),this.tokens.push({type:o?"loose_item_start":"list_item_start"}),this.token(l,!1,s),this.tokens.push({type:"list_item_end"});this.tokens.push({type:"list_end"})}else if(i=this.rules.html.exec(e))e=e.substring(i[0].length),this.tokens.push({type:this.options.sanitize?"paragraph":"html",pre:!this.options.sanitizer&&("pre"===i[1]||"script"===i[1]||"style"===i[1]),text:i[0]});else if(!s&&t&&(i=this.rules.def.exec(e)))e=e.substring(i[0].length),this.tokens.links[i[1].toLowerCase()]={href:i[2],title:i[3]};else if(t&&(i=this.rules.table.exec(e))){for(e=e.substring(i[0].length),l={type:"table",header:i[1].replace(/^ *| *\| *$/g,"").split(/ *\| */),align:i[2].replace(/^ *|\| *$/g,"").split(/ *\| */),cells:i[3].replace(/(?: *\| *)?\n$/,"").split("\n")},d=0;d<l.align.length;d++)/^ *-+: *$/.test(l.align[d])?l.align[d]="right":/^ *:-+: *$/.test(l.align[d])?l.align[d]="center":/^ *:-+ *$/.test(l.align[d])?l.align[d]="left":l.align[d]=null;for(d=0;d<l.cells.length;d++)l.cells[d]=l.cells[d].replace(/^ *\| *| *\| *$/g,"").split(/ *\| */);this.tokens.push(l)}else if(t&&(i=this.rules.paragraph.exec(e)))e=e.substring(i[0].length),this.tokens.push({type:"paragraph",text:"\n"===i[1].charAt(i[1].length-1)?i[1].slice(0,-1):i[1]});else if(i=this.rules.text.exec(e))e=e.substring(i[0].length),this.tokens.push({type:"text",text:i[0]});else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0));return this.tokens};var f={escape:/^\\([\\`*{}\[\]()#+\-.!_>])/,autolink:/^<([^ >]+(@|:\/)[^ >]+)>/,url:d,tag:/^<!--[\s\S]*?-->|^<\/?\w+(?:"[^"]*"|'[^']*'|[^'">])*?>/,link:/^!?\[(inside)\]\(href\)/,reflink:/^!?\[(inside)\]\s*\[([^\]]*)\]/,nolink:/^!?\[((?:\[[^\]]*\]|[^\[\]])*)\]/,strong:/^__([\s\S]+?)__(?!_)|^\*\*([\s\S]+?)\*\*(?!\*)/,em:/^\b_((?:[^_]|__)+?)_\b|^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,code:/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,br:/^ {2,}\n(?!\s*$)/,del:d,smile:/^:([a-z0-9_]+):/,command:/^!(roll(?:0|[1-9][0-9]?)-[1-9][0-9]?[0-9]?|flip[1-9][0-9]?%)/,text:/^[\s\S]+?(?=[\\<!\[_*`:]| {2,}\n|$)/};f._inside=/(?:\[[^\]]*\]|[^\[\]]|\](?=[^\[]*\]))*/,f._href=/\s*<?([\s\S]*?)>?(?:\s+['"]([\s\S]*?)['"])?\s*/,f.link=c(f.link)("inside",f._inside)("href",f._href)(),f.reflink=c(f.reflink)("inside",f._inside)(),f.normal=u({},f),f.pedantic=u({},f.normal,{strong:/^__(?=\S)([\s\S]*?\S)__(?!_)|^\*\*(?=\S)([\s\S]*?\S)\*\*(?!\*)/,em:/^_(?=\S)([\s\S]*?\S)_(?!_)|^\*(?=\S)([\s\S]*?\S)\*(?!\*)/}),f.gfm=u({},f.normal,{escape:c(f.escape)("])","~|])")(),url:/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,del:/^~~(?=\S)([\s\S]*?\S)~~/,text:c(f.text)("]|","~]|")("|","|https?://|")()}),f.breaks=u({},f.gfm,{br:c(f.br)("{2,}","*")(),text:c(f.gfm.text)("{2,}","*")()}),o.rules=f,o.output=function(e,t,s){return new o(t,s).output(e)},o.prototype.output=function(e){for(var t,n,o,i,r="";e;)if(i=this.rules.escape.exec(e))e=e.substring(i[0].length),r+=i[1];else if(i=this.rules.autolink.exec(e))e=e.substring(i[0].length),"@"===i[2]?(n=":"===i[1].charAt(6)?this.mangle(i[1].substring(7)):this.mangle(i[1]),o=this.mangle("mailto:")+n):o=n=a(i[1]),r+=this.renderer.link(o,null,n);else if(this.inLink||!(i=this.rules.url.exec(e))){if(i=this.rules.tag.exec(e))!this.inLink&&/^<a /i.test(i[0])?this.inLink=!0:this.inLink&&/^<\/a>/i.test(i[0])&&(this.inLink=!1),e=e.substring(i[0].length),r+=this.options.sanitize?this.options.sanitizer?this.options.sanitizer(i[0]):a(i[0]):i[0];else if(i=this.rules.link.exec(e))e=e.substring(i[0].length),this.inLink=!0,r+=this.outputLink(i,{href:i[2],title:i[3]}),this.inLink=!1;else if((i=this.rules.reflink.exec(e))||(i=this.rules.nolink.exec(e))){if(e=e.substring(i[0].length),t=(i[2]||i[1]).replace(/\s+/g," "),!(t=this.links[t.toLowerCase()])||!t.href){r+=i[0].charAt(0),e=i[0].substring(1)+e;continue}this.inLink=!0,r+=this.outputLink(i,t),this.inLink=!1}else if(i=this.rules.strong.exec(e))e=e.substring(i[0].length),r+=this.renderer.strong(this.output(i[2]||i[1]));else if(i=this.rules.em.exec(e))e=e.substring(i[0].length),r+=this.renderer.em(this.output(i[2]||i[1]));else if(i=this.rules.code.exec(e))e=e.substring(i[0].length),r+=this.renderer.codespan(a(i[2],!0));else if(i=this.rules.br.exec(e))e=e.substring(i[0].length),r+=this.renderer.br();else if(i=this.rules.del.exec(e))e=e.substring(i[0].length),r+=this.renderer.del(this.output(i[1]));else if((i=this.rules.smile.exec(e))&&s.default.has(i[1]))e=e.substring(i[0].length),r+=this.renderer.smile(i[1]);else if(i=this.rules.command.exec(e))e=e.substring(i[0].length),r+=this.renderer.command(i[0],i[1].slice(0,4),i[1].slice(4));else if(i=this.rules.text.exec(e))e=e.substring(i[0].length),r+=this.renderer.text(a(this.smartypants(i[0])));else if(e)throw new Error("Infinite loop on byte: "+e.charCodeAt(0))}else e=e.substring(i[0].length),o=n=a(i[1]),r+=this.renderer.link(o,null,n);return r},o.prototype.outputLink=function(e,t){var s=a(t.href),n=t.title?a(t.title):null;return this.renderer.link(s,n,this.output(e[1]))},o.prototype.smartypants=function(e){return this.options.smartypants?e.replace(/---/g,"—").replace(/--/g,"–").replace(/(^|[-\u2014/(\[{"\s])'/g,"$1‘").replace(/'/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1“").replace(/"/g,"”").replace(/\.{3}/g,"…"):e},o.prototype.mangle=function(e){if(!this.options.mangle)return e;for(var t,s="",n=e.length,o=0;o<n;o++)t=e.charCodeAt(o),Math.random()>.5&&(t="x"+t.toString(16)),s+="&#"+t+";";return s},i.prototype.code=function(e,t,s){if(this.options.highlight){var n=this.options.highlight(e,t);null!=n&&n!==e&&(s=!0,e=n)}return t?'<pre><code class="'+this.options.langPrefix+a(t,!0)+'">'+(s?e:a(e,!0))+"\n</code></pre>\n":"<pre><code>"+(s?e:a(e,!0))+"\n</code></pre>"},i.prototype.blockquote=function(e){return"<blockquote>\n"+e+"</blockquote>\n"},i.prototype.html=function(e){return e},i.prototype.heading=function(e,t,s){return"<h"+t+' id="'+this.options.headerPrefix+s.toLowerCase().replace(/[^\w]+/g,"-")+'">'+e+"</h"+t+">\n"},i.prototype.hr=function(){return this.options.xhtml?"<hr/>\n":"<hr>\n"},i.prototype.list=function(e,t){var s=t?"ol":"ul";return"<"+s+">\n"+e+"</"+s+">\n"},i.prototype.listitem=function(e){return"<li>"+e+"</li>\n"},i.prototype.paragraph=function(e){return"<p>"+e+"</p>\n"},i.prototype.table=function(e,t){return"<table>\n<thead>\n"+e+"</thead>\n<tbody>\n"+t+"</tbody>\n</table>\n"},i.prototype.tablerow=function(e){return"<tr>\n"+e+"</tr>\n"},i.prototype.tablecell=function(e,t){var s=t.header?"th":"td";return(t.align?"<"+s+' style="text-align:'+t.align+'">':"<"+s+">")+e+"</"+s+">\n"},i.prototype.strong=function(e){return"<strong>"+e+"</strong>"},i.prototype.em=function(e){return"<em>"+e+"</em>"},i.prototype.codespan=function(e){return"<code>"+e+"</code>"},i.prototype.br=function(){return this.options.xhtml?"<br/>":"<br>"},i.prototype.del=function(e){return"<del>"+e+"</del>"},i.prototype.smile=function(e){return`<i class="smile smile-${e}" title=":${e}:"></i>`},i.prototype.command=function(e,t,s){if(!this.commands||this.cmdi>=this.commands.length)return a(e);const n=this.commands[this.cmdi];switch(t){case"roll":return this.cmdi++,`<i class="fa fa-cube post-command post-roll-command"`+`title="${e}"> ${n.val} (${s})</i>`;case"flip":return this.cmdi++,`<i class="fa fa-cube post-command post-flip-command `+`post-flip-command_${n.val?"hit":"miss"}"`+`title="${e}"> ${s}</i>`}},i.prototype.link=function(e,t,s){if(this.options.sanitize){try{var n=decodeURIComponent(l(e)).replace(/[^\w:]/g,"").toLowerCase()}catch(e){return""}if(0===n.indexOf("javascript:")||0===n.indexOf("vbscript:"))return""}var o='<a href="'+e+'"';return t&&(o+=' title="'+t+'"'),o+=">"+s+"</a>"},i.prototype.image=function(e,t,s){var n='<img src="'+e+'" alt="'+s+'"';return t&&(n+=' title="'+t+'"'),n+=this.options.xhtml?"/>":">"},i.prototype.text=function(e){return e},r.parse=function(e,t,s){return new r(t,s).parse(e)},r.prototype.parse=function(e){this.inline=new o(e.links,this.options,this.renderer),this.tokens=e.reverse();for(var t="";this.next();)t+=this.tok();return t},r.prototype.next=function(){return this.token=this.tokens.pop()},r.prototype.peek=function(){return this.tokens[this.tokens.length-1]||0},r.prototype.parseText=function(){for(var e=this.token.text;"text"===this.peek().type;)e+="\n"+this.next().text;return this.inline.output(e)},r.prototype.tok=function(){switch(this.token.type){case"space":return"<br>";case"hr":return this.renderer.hr();case"heading":return this.renderer.heading(this.inline.output(this.token.text),this.token.depth,this.token.text);case"code":return this.renderer.code(this.token.text,this.token.lang,this.token.escaped);case"table":var e,t,s,n,o="",i="";for(s="",e=0;e<this.token.header.length;e++)({header:!0,align:this.token.align[e]}),s+=this.renderer.tablecell(this.inline.output(this.token.header[e]),{header:!0,align:this.token.align[e]});for(o+=this.renderer.tablerow(s),e=0;e<this.token.cells.length;e++){for(t=this.token.cells[e],s="",n=0;n<t.length;n++)s+=this.renderer.tablecell(this.inline.output(t[n]),{header:!1,align:this.token.align[n]});i+=this.renderer.tablerow(s)}return this.renderer.table(o,i);case"blockquote_start":for(i="";"blockquote_end"!==this.next().type;)i+=this.tok();return this.renderer.blockquote(i);case"list_start":for(var i="",r=this.token.ordered;"list_end"!==this.next().type;)i+=this.tok();return this.renderer.list(i,r);case"list_item_start":for(i="";"list_item_end"!==this.next().type;)i+="text"===this.token.type?this.parseText():this.tok();return this.renderer.listitem(i);case"loose_item_start":for(i="";"list_item_end"!==this.next().type;)i+=this.tok();return this.renderer.listitem(i);case"html":var a=this.token.pre||this.options.pedantic?this.token.text:this.inline.output(this.token.text);return this.renderer.html(a);case"paragraph":return this.renderer.paragraph(this.inline.output(this.token.text));case"text":return this.renderer.paragraph(this.parseText())}},d.exec=d,h.options=h.setOptions=function(e){return u(h.defaults,e),h},h.defaults={gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!1,sanitizer:null,mangle:!0,smartLists:!1,silent:!1,highlight:null,langPrefix:"lang-",smartypants:!1,headerPrefix:"",renderer:new i,xhtml:!1},h.Parser=r,h.parser=r.parse,h.Renderer=i,h.Lexer=n,h.lexer=n.lex,h.InlineLexer=o,h.inlineLexer=o.output,h.parse=h,h.noop=d,t.default=h}),define("ts/templates/body",["require","exports","ts/templates/index","ts/state/index","ts/util/index","ts/templates/marked"],function(e,t,s,n,o,i){"use strict";function r(e,t,i){if(!t)return o.escape(e[0]);const r=+e[0].slice(2),a=t.find(e=>e[0]===r);if(!a)return o.escape(e[0]);const l=a[1]!==i,c=!n.page.thread;return s.renderPostLink(r,l,c)}Object.defineProperty(t,"__esModule",{value:!0});const a=i.default.noop;class l extends i.default.Lexer{constructor(e){super(e),Object.assign(this.rules,{code:a,def:a,heading:a,hr:a,lheading:a})}}class c extends i.default.InlineLexer{constructor(e,t,s){e[""]={href:"post-link",title:""},super(e,t),this.post=s;const n=this.rules.text.source;Object.assign(this.rules,{del:/^%%([\s\S]+?)%%/,link:a,nolink:a,reflink:/^>>\d+()/,text:new RegExp(n.replace("]|",">%]|"))})}outputLink(e,t){return"post-link"===t.href?r(e,this.post.links,this.post.op):super.outputLink(e,t)}}class d extends i.default.Parser{parse(e,t){this.inline=new c(e.links,this.options,t),this.tokens=e.reverse();let s="";for(;this.next();)s+=this.tok();return s}}const u={vlive:String.raw`https?://(?:(?:www|m)\.)?vlive\.tv/video/([0-9]+)`,youtube:String.raw`https?://(?:[^\.]+\.)?`+String.raw`(?:youtube\.com/watch\?(?:.+&)?v=|youtu\.be/)`+String.raw`([a-zA-Z0-9_-]+)`,youtubepls:String.raw`https?://(?:[^\.]+\.)?`+String.raw`youtube\.com/playlist\?(?:.+&)?list=`+String.raw`([a-zA-Z0-9_-]+)`};t.bodyEmbeds=(()=>{const e={};for(const t of Object.keys(u))e[t]=new RegExp(u[t]);return e})(),t.linkEmbeds=(()=>{const e={};for(const t of Object.keys(u))e[t]=new RegExp("^"+u[t]);return e})();class h extends i.default.Renderer{constructor(e){super(),this.commands=e,this.cmdi=0}blockquote(e){return"<blockquote>&gt; "+e+"</blockquote>"}link(e,s,n){if(!e.startsWith("http://")&&!e.startsWith("https://"))return e;let i="<a ";for(const r of Object.keys(t.linkEmbeds))if(t.linkEmbeds[r].test(o.unescape(e))){i+=` class="post-embed post-${r}-embed trigger-media-hover"`,i+=` data-provider="${r}"`;break}return i+=` href="${e}"`,i+=' rel="noreferrer" target="_blank"',i+=`>${n}</a>`}}t.render=function(e){const t=Object.assign({},i.default.defaults,{tables:!1,breaks:!0,sanitize:!0,renderer:new h(e.commands)}),s=new l(t).lex(e.body);return new d(t).parse(s,e)}}),define("ts/templates/index",["require","exports","ts/templates/isomorph","ts/templates/body"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}(s),t.bodyEmbeds=n.bodyEmbeds,t.linkEmbeds=n.linkEmbeds,t.renderBody=n.render}),define("ts/posts/embed",["require","exports","ts/db/index","ts/templates/index","ts/util/index","ts/vars/index"],function(e,t,s,n,o,i){"use strict";function r(e,t){return e=d[t](e),o.fetchJSON(e).then(u[t])}function a(e,t){return s.getEmbed(e).catch(()=>r(e,t).then(t=>(s.setEmbed(e,t,i.EMBED_CACHE_EXPIRY_MS),t)))}function l(e){const t=e.dataset.provider,s=e.href;return a(s,t).then(s=>{const n=document.createElement("i");n.className=`post-embed-icon ${h[t]}`,e.firstChild.replaceWith(n," "+s.title),e.dataset.html=s.html,e.dataset.width=s.width.toString(),e.dataset.height=s.height.toString(),e.dataset.thumbnail_url=s.thumbnail_url,e.dataset.thumbnail_width=s.thumbnail_width.toString(),e.dataset.thumbnail_height=s.thumbnail_height.toString(),e.classList.add("trigger-media-popup")},e=>{console.error(`Failed to embed ${s}: ${e.message}`)})}Object.defineProperty(t,"__esModule",{value:!0});const c="AIzaSyDr4-0yU43u4WzrPIwAL-IdRtHAlY7dnbc",d={vlive:e=>`/api/embed?url=${e}`,youtube:e=>{const t=n.linkEmbeds.youtube.exec(e)[1];return`https://www.googleapis.com/youtube/v3/videos?${[`key=${c}`,`id=${t}`,`maxWidth=1280`,`maxHeight=720`,`part=snippet,player`].join("&")}`},youtubepls:e=>{const t=n.linkEmbeds.youtubepls.exec(e)[1];return`https://www.googleapis.com/youtube/v3/playlists?${[`key=${c}`,`id=${t}`,`part=snippet,contentDetails`].join("&")}`}},u={vlive:e=>e,youtube:e=>{const t=e.items[0];if(!t)throw new Error("not found");const s=t.id,n=t.player,o=t.snippet,i=o.thumbnails,r=i.maxres||i.high;return{title:o.title,html:`<iframe src="https://www.youtube.com/embed/${s}?autoplay=1"></iframe>`,width:n.embedWidth||1280,height:n.embedHeight||720,thumbnail_url:r.url,thumbnail_width:r.width,thumbnail_height:r.height}},youtubepls:e=>{const t=e.items[0];if(!t)throw new Error("not found");const s=t.id,n=t.snippet,o=t.contentDetails.itemCount,i=`${n.title} (${o})`,r=n.thumbnails,a=r.maxres||r.high;return{title:i,html:`<iframe src="https://www.youtube.com/embed/videoseries?list=${s}&autoplay=1"></iframe>`,width:1280,height:720,thumbnail_url:a.url,thumbnail_width:a.width,thumbnail_height:a.height}}},h={vlive:"fa fa-hand-peace-o",youtube:"fa fa-youtube-play",youtubepls:"fa fa-bars"};t.render=function(e){if(!e.classList.contains("post_embed"))return Promise.resolve();const t=[];for(const s of e.querySelectorAll(i.POST_EMBED_SEL))t.push(l(s));return Promise.all(t).then(o.noop)}}),define("ts/posts/view",["require","exports","ts/base/index","ts/lang/index","ts/options/index","ts/state/index","ts/templates/index","ts/util/index","ts/vars/index","ts/posts/embed","ts/posts/model"],function(e,t,s,n,o,i,r,a,l,c,d){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class u extends s.View{constructor(e,t){const s={model:e},n=new d.Thread(e),o=n.id!==i.page.thread,a="all"===i.page.board;s.el=t||r.makePostContext(n,e,null,o,a).renderNode(),super(s),this.model.view=this,this.model.seenOnce=!!t}afterRender(){return this.renderTime(),c.render(this.el)}renderTime(){let e=r.readableTime(this.model.time);const t=this.el.querySelector("time");o.default.relativeTime&&(t.setAttribute("title",e),e=r.relativeTime(this.model.time)),t.textContent=e}renderBacklinks(){const e=!i.page.thread,t=Object.keys(this.model.backlinks).map(t=>{const s=this.model.backlinks[t]!==this.model.op;return r.renderPostLink(+t,s,e)});if(!t.length)return;const s=new r.TemplateContext("post-backlinks",{Backlinks:t,LReplies:n.ln.Common.UI.replies}).render();this.el.querySelector(l.POST_BACKLINKS_SEL).innerHTML=s}removeThread(){this.el.closest(l.THREAD_SEL).remove()}renderSticky(){}reposition(){const{id:e,op:t}=this.model,s=document.getElementById(`thread${t}`);if(s){for(const t of Array.from(s.children))switch(t.tagName){case"ARTICLE":if(a.getID(t)>e)return void t.before(this.el);break;case"ASIDE":return void t.before(this.el)}s.append(this.el)}}scrolledPast(){const e=this.el.getBoundingClientRect(),t=document.body.clientWidth,s=document.body.clientHeight;return e.bottom<s&&e.left>0&&e.left<t}}t.default=u}),define("ts/posts/model",["require","exports","ts/base/index","ts/common/index","ts/state/index","ts/ui/index","ts/posts/images"],function(e,t,s,n,o,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class a{constructor(e){this.id=e.op}}t.Thread=a;class l extends s.Model{constructor(e){super(),Object.assign(this,e)}getFileByIndex(e){return new c(this.files[e])}getFileByHash(e){return new c(this.files.find(t=>t.SHA1===e))}isOP(){return this.id===this.op}remove(){this.collection&&this.collection.remove(this),this.view&&this.view.remove()}propagateLinks(){if(this.isReply()&&i.notifyAboutReply(this),this.links)for(const[e]of this.links){const t=o.posts.get(e);t&&t.insertBacklink(this.id,this.op)}}isReply(){if(!this.links)return!1;for(const[e]of this.links)if(o.mine.has(e))return!0;return!1}insertBacklink(e,t){this.backlinks||(this.backlinks={}),this.backlinks[e]=t,this.view.renderBacklinks()}setDeleted(){this.isOP()?o.page.thread?location.href="/all/":(o.posts.removeThread(this),this.view.removeThread()):(o.posts.remove(this),this.view.remove())}seen(){return!!this.seenOnce||(this.seenOnce=o.mine.has(this.id),!!this.seenOnce||!document.hidden&&(this.seenOnce=this.view.scrolledPast(),!!this.seenOnce))}}t.Post=l;class c{get thumb(){return r.thumbPath(this.thumbType,this.SHA1)}get src(){return r.sourcePath(this.fileType,this.SHA1)}get transparent(){return this.thumbType===n.fileTypes.png}constructor(e){Object.assign(this,e)}}t.File=c}),define("ts/posts/popup",["require","exports","classnames","preact","ts/options/index","ts/state/index","ts/util/index","ts/vars/index"],function(e,t,s,n,o,i,r,a){"use strict";function l({width:e,height:t}){const s=e/t,n=document.body.clientWidth,o=window.innerHeight;return e=Math.min(e,n),(t=Math.ceil(e/s))>o&&(t=o,e=Math.ceil(t*s)),{width:e,height:t,left:(n-e)/2,top:(o-t)/2}}Object.defineProperty(t,"__esModule",{value:!0});const c=new Set;t.isOpen=function(e){return c.has(e)},t.getCenteredRect=l;class d extends n.Component{constructor(e){super(e),this.itemEl=null,this.frameUrl="",this.aspect=0,this.baseX=0,this.baseY=0,this.startX=0,this.startY=0,this.startW=0,this.startH=0,this.handleGlobalKey=(e=>{27===e.keyCode&&this.props.onClose()}),this.handleMediaDrag=(e=>{e.preventDefault()}),this.handleMediaVolume=(()=>{o.default.volume=this.itemEl.volume}),this.handleMediaDown=(e=>{0===e.button&&(this.setState({moving:!0}),this.baseX=e.clientX,this.baseY=e.clientY,this.startX=this.state.left,this.startY=this.state.top)}),this.handleResizerDown=(e=>{0===e.button&&(e.preventDefault(),this.setState({resizing:!0}),this.baseX=e.clientX,this.baseY=e.clientY,this.startX=this.state.left,this.startY=this.state.top,this.startW=this.state.width,this.startH=this.state.height)}),this.handleGlobalMove=(e=>{if(this.state.moving)this.setState({left:this.startX+e.clientX-this.baseX,top:this.startY+e.clientY-this.baseY});else if(this.state.resizing){const t=e.clientX-this.baseX,s=e.clientY-this.baseY;let n=this.startX+t,o=this.startY+s,i=this.startW-t,r=this.startH-s;i<200&&(n-=200-i),r<200&&(o-=200-r),i=Math.max(i,200),r=Math.max(r,200),this.setState({left:n,top:o,width:i,height:r})}}),this.handleControlsClick=(e=>{e.stopPropagation(),this.setState({moving:!1,resizing:!1})}),this.handleGlobalClick=(e=>{0===e.button&&(this.state.moving?e.clientX===this.baseX&&e.clientY===this.baseY&&this.props.onClose():this.state.resizing||o.default.popupBackdrop&&this.props.onClose()),this.setState({moving:!1,resizing:!1})}),this.handleMediaWheel=(e=>{e.preventDefault();const t=e.deltaY<0?1:-1;let{left:s,top:n,width:o,height:i}=this.state;o<=50&&t<0||(s-=a.ZOOM_STEP_PX/2*t,n-=a.ZOOM_STEP_PX/this.aspect/2*t,o=Math.max(50,o+a.ZOOM_STEP_PX*t),i=Math.ceil(o/this.aspect),this.setState({left:s,top:n,width:o,height:i}))});const{width:t,height:s}=e,n=l({width:t,height:s});this.aspect=t/s,e.embed&&(this.frameUrl=e.html.match(/src="(.*)"/)[1]),this.state={left:n.left,top:n.top,width:n.width,height:n.height,moving:!1,resizing:!1}}componentDidMount(){c.add(this.props.url),r.trigger(4),document.addEventListener("keydown",this.handleGlobalKey),document.addEventListener("mousemove",this.handleGlobalMove),document.addEventListener("click",this.handleGlobalClick),(this.props.video||this.props.record)&&(this.itemEl.volume=o.default.volume,this.itemEl.src=this.props.url)}componentWillUnmount(){c.delete(this.props.url),document.removeEventListener("keydown",this.handleGlobalKey),document.removeEventListener("mousemove",this.handleGlobalMove),document.removeEventListener("click",this.handleGlobalClick)}render({video:e,record:t,embed:o},{left:i,top:r}){let a="",l=null;return e?(a="popup_video",l=this.renderVideo):t?(a="popup_record",l=this.renderRecord):o?(a="popup_embed",l=this.renderEmbed):(a="popup_image",l=this.renderImage),n.h("div",{class:s("popup",a),style:{left:i,top:r}},l.call(this),o?this.renderControls():null)}renderVideo(){const{width:e}=this.state;return n.h("div",{class:"popup-video"},n.h("video",{class:"popup-item popup-video-item",ref:r.setter(this,"itemEl"),style:{width:e},loop:!0,autoPlay:!0,controls:this.needVideoControls(),onVolumeChange:this.handleMediaVolume}),n.h("div",{class:s("popup-video-overlay",{"popup-video-overlay_full":!this.needVideoControls()}),onMouseDown:this.handleMediaDown,onWheel:this.handleMediaWheel}))}renderImage(){const{url:e}=this.props,{width:t}=this.state;return n.h("img",{class:"popup-item",ref:r.setter(this,"itemEl"),style:{width:t},src:e,draggable:0,onDragStart:this.handleMediaDrag,onMouseDown:this.handleMediaDown,onWheel:this.handleMediaWheel})}renderRecord(){return n.h("div",{class:"popup-record",onMouseDown:this.handleMediaDown},n.h("i",{class:"popup-record-icon fa fa-music"}),n.h("audio",{class:"popup-item popup-record-item",ref:r.setter(this,"itemEl"),autoPlay:!0,controls:!0,onVolumeChange:this.handleMediaVolume}))}renderEmbed(){const{width:e,height:t,moving:s,resizing:o}=this.state,i=s||o?"none":"auto";return n.h("iframe",{class:"popup-item",ref:r.setter(this,"itemEl"),style:{width:e,height:t,pointerEvents:i},allowFullScreen:!0,frameBorder:0,referrerPolicy:"no-referrer",sandbox:"allow-scripts allow-same-origin allow-popups",src:this.frameUrl})}renderControls(){return n.h("div",{class:"popup-controls",onClick:this.handleControlsClick},n.h("a",{class:"control popup-control popup-resize-control",onMouseDown:this.handleResizerDown},n.h("i",{class:"fa fa-expand fa-flip-horizontal"})),n.h("a",{class:"control popup-control popup-move-control",onMouseDown:this.handleMediaDown},n.h("i",{class:"fa fa-arrows"})),n.h("a",{class:"control popup-control popup-close-control",onClick:this.props.onClose},n.h("i",{class:"fa fa-remove"})))}needVideoControls(){return this.props.video&&!this.props.transparent&&(this.props.audio||this.props.duration>10)}}class u extends n.Component{constructor(){super(...arguments),this.state={popups:[]},this.open=(e=>{const t=e.target;if(!t.matches)return;if(0!==e.button)return;e.preventDefault();const s={video:!1,audio:!1,record:!1,embed:!1,transparent:!1,url:"",html:"",width:0,height:0,duration:0};if(t.matches(a.POST_FILE_THUMB_SEL)){const e=i.getModel(t),n=e.getFileByHash(t.dataset.sha1);Object.assign(s,{video:n.video,audio:n.audio,record:n.audio&&!n.video,transparent:n.transparent,url:n.src,width:n.dims[0]||200,height:n.dims[1]||200,duration:n.length})}else{if(!t.matches(a.POST_EMBED_SEL))return;Object.assign(s,{embed:!0,url:t.href,html:t.dataset.html,width:+t.dataset.width,height:+t.dataset.height})}let{popups:n}=this.state;const o=n.length;(n=n.filter(e=>e.url!==s.url)).length===o&&(n=n.concat(s)),this.setState({popups:n})})}componentDidMount(){r.on(document,"click",this.open,{selector:a.TRIGGER_MEDIA_POPUP_SEL})}render({},{popups:e}){return n.h("div",{class:"popup-container-inner"},e.map(e=>n.h(d,Object.assign({},e,{key:e.url,onClose:this.makeHandleClose(e.url)}))))}makeHandleClose(e){return()=>{let{popups:t}=this.state;t=t.filter(t=>t.url!==e),this.setState({popups:t})}}}t.init=function(){const e=document.querySelector(a.POPUP_CONTAINER_SEL);e&&n.render(n.h(u,null),e)}}),define("ts/posts/hover",["require","exports","ts/api/index","ts/base/index","ts/options/index","ts/state/index","ts/util/index","ts/vars/index","ts/posts/model","ts/posts/popup","ts/posts/view"],function(e,t,s,n,o,i,r,a,l,c,d){"use strict";function u(e){const t=e.cloneNode(!0);return t.removeAttribute("id"),t.classList.add("post_hover"),t}function h(e){return __awaiter(this,void 0,void 0,function*(){const t=e.target;if(!t.matches||!t.matches(a.POST_LINK_SEL))return void(P.length&&!E&&(E=window.setTimeout(A,1e3*a.POST_HOVER_TIMEOUT_SECS)));const n=r.getID(t);if(!n)return;const o=P.length;if(o&&P[o-1].model.id===n)return;let c=i.posts.get(n);if(!c){const e=yield s.default.post.get(n);c=new l.Post(e);const t=new d.default(c,null);yield t.afterRender(),c.seenOnce=!0,i.posts.add(c)}const u=new T(c,t);P.push(u)})}function p(e,t,s){if(c.isOpen(e))return;const n=c.getCenteredRect({width:t,height:s});(C=document.createElement("img")).className="media_hover",C.src=e,C.style.left=n.left+"px",C.style.top=n.top+"px",C.width=n.width,x.append(C)}function f(e){const t=i.getModel(e).getFileByHash(e.dataset.sha1),[s,n]=t.dims;p(t.src,s,n)}function m(e){const t=e.dataset.thumbnail_url;t&&p(t,+e.dataset.thumbnail_width,+e.dataset.thumbnail_height)}function g(e){if(y(),!o.default.imageHover)return;const t=e.target;t.matches&&t.matches(a.TRIGGER_MEDIA_HOVER_SEL)&&(t.matches(a.POST_FILE_THUMB_SEL)?f(t):t.matches(a.POST_EMBED_SEL)&&m(t))}function A(){E=0;const e=_.event.target;for(let t=P.length-1;t>=0;t--){const s=P[t];if(e===s.parent||s.el.contains(e))return;P.pop().remove()}}function b(){for(;P.length;)P.pop().remove()}function y(){C&&(C.remove(),C=null)}function w(e){e.target!==_.event.target&&(_.event=e)}function v(e){e.target!==k&&(k=e.target,clearTimeout(S),S=window.setTimeout(()=>w(e),1e3*a.HOVER_TRIGGER_TIMEOUT_SECS))}Object.defineProperty(t,"__esModule",{value:!0});const _=r.emitChanges({event:{target:null}});let x=null,k=null,S=0,E=0;const P=[];let C=null;class T extends n.View{constructor(e,t){const{el:s}=e.view;super({el:u(s)}),this.parent=t,this.model=Object.assign({},e),this.render(),t.addEventListener("click",b)}remove(){this.parent.removeEventListener("click",b),super.remove()}render(){const e=new RegExp("[>/]"+r.getClosestID(this.parent));for(const t of this.el.querySelectorAll(a.POST_LINK_SEL))e.test(t.textContent)&&t.classList.add("post-link_ref");x.append(this.el),this.position()}position(){const e=this.el.offsetHeight,t=this.parent.getBoundingClientRect(),s=t.left+window.pageXOffset;let n=t.top+window.pageYOffset;this.el.style.left=s+"px",(n-=e)<window.pageYOffset&&(n+=e+20),this.el.style.top=n+"px"}}t.isOpen=function(){return!!C||!!P.length},t.init=function(){(x=document.querySelector(a.HOVER_CONTAINER_SEL)).classList.add(i.page.thread?"hover-container_thread":"hover-container_board"),document.addEventListener("mouseover",v),_.onChange("event",h),_.onChange("event",g),r.hook(4,y)}}),define("node_modules/vmsg/vmsg",["require","exports"],function(e,t){"use strict";function s(e){return(e|=0)<10?`0${e}`:`${Math.min(e,99)}`}function n(){return(new Date).getTime()}function o(){function e(e,t){if(WebAssembly.instantiateStreaming){const s=fetch(e,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(s,t)}return new Promise((s,n)=>{const o=new XMLHttpRequest;o.open("GET",e),o.responseType="arraybuffer",o.onload=(()=>{s(WebAssembly.instantiate(o.response,t))}),o.onerror=n,o.send()})}function t(e){const t=a;return a+=e,t}function s(e){postMessage({type:"internal-error",data:e})}function n(e){if(!(c=l.vmsg_init(e)))return!1;const t=new Uint32Array(r.buffer,c,1)[0];return d=new Float32Array(r.buffer,t),!0}function o(e){return d.set(e),l.vmsg_encode(c,e.length)>=0}function i(){if(l.vmsg_flush(c)<0)return null;const e=new Uint32Array(r.buffer,c+4,1)[0],t=new Uint32Array(r.buffer,c+8,1)[0],s=new Uint8Array(r.buffer,e,t),n=new Blob([s],{type:"audio/mpeg"});return l.vmsg_free(c),c=null,d=null,n}let r=null,a=5242880,l=null,c=null,d=null;onmessage=(a=>{const c=a.data;switch(c.type){case"init":const{wasmURL:a,shimURL:d}=c.data;Promise.resolve().then(()=>(self.WebAssembly||importScripts(d),r=new WebAssembly.Memory({initial:256,maximum:256}),{memory:r,pow:Math.pow,exit:s,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:t})).then(t=>e(a,{env:t})).then(e=>{l=e.instance.exports,postMessage({type:"init",data:null})}).catch(e=>{postMessage({type:"init-error",data:e.toString()})});break;case"start":if(!n(c.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(!o(c.data))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const u=i();if(!u)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:u})}})}function i(e){return new Promise((t,s)=>{if(d)throw new Error("Record form is already opened");d=!0,new c(e,t,s)}).then(e=>(d=!1,e),e=>{throw d=!1,e})}function r(e,t,s){for(var n=t*e.sampleRate,o=n+(t-2*s)*e.sampleRate,i=e.createBuffer(1,o,e.sampleRate),r=i.getChannelData(0),a=s*e.sampleRate,l=a,c=n-a,d=0;d<n;++d){var u;u=d<l?Math.sqrt(d/a):d>=c?Math.sqrt(1-(d-c)/a):1,r[d]=u}for(d=n;d<o;++d)r[d]=0;return i}function a(e,t,s,n){for(var o=t*e.sampleRate,i=o+(t-2*s)*e.sampleRate,r=e.createBuffer(1,i,e.sampleRate),a=r.getChannelData(0),l=0;l<o;++l)a[l]=n?(o-l)/i:l/o;for(l=o;l<i;++l)a[l]=0;return r}function l(e){this.context=e;var t=(e.createGain||e.createGainNode).call(e),s=(e.createGain||e.createGainNode).call(e);this.input=t,this.output=s;var n=e.createBufferSource(),o=e.createBufferSource(),i=e.createBufferSource(),l=e.createBufferSource();this.shiftDownBuffer=a(e,p,h,!1),this.shiftUpBuffer=a(e,p,h,!0),n.buffer=this.shiftDownBuffer,o.buffer=this.shiftDownBuffer,i.buffer=this.shiftUpBuffer,l.buffer=this.shiftUpBuffer,n.loop=!0,o.loop=!0,i.loop=!0,l.loop=!0;var c=(e.createGain||e.createGainNode).call(e),d=(e.createGain||e.createGainNode).call(e),f=(e.createGain||e.createGainNode).call(e);f.gain.value=0;var m=(e.createGain||e.createGainNode).call(e);m.gain.value=0,n.connect(c),o.connect(d),i.connect(f),l.connect(m);var g=(e.createGain||e.createGainNode).call(e),A=(e.createGain||e.createGainNode).call(e),b=(e.createDelay||e.createDelayNode).call(e),y=(e.createDelay||e.createDelayNode).call(e);c.connect(g),d.connect(A),f.connect(g),m.connect(A),g.connect(b.delayTime),A.connect(y.delayTime);var w=e.createBufferSource(),v=e.createBufferSource(),_=r(e,p,h);w.buffer=_,v.buffer=_,w.loop=!0,v.loop=!0;var x=(e.createGain||e.createGainNode).call(e),k=(e.createGain||e.createGainNode).call(e);x.gain.value=0,k.gain.value=0,w.connect(x.gain),v.connect(k.gain),t.connect(b),t.connect(y),b.connect(x),y.connect(k),x.connect(s),k.connect(s);var S=e.currentTime+.05,E=S+p-h;n.start(S),o.start(E),i.start(S),l.start(E),w.start(S),v.start(E),this.mod1=n,this.mod2=o,this.mod1Gain=c,this.mod2Gain=d,this.mod3Gain=f,this.mod4Gain=m,this.modGain1=g,this.modGain2=A,this.fade1=w,this.fade2=v,this.mix1=x,this.mix2=k,this.delay1=b,this.delay2=y,this.setDelay(u)}Object.defineProperty(t,"__esModule",{value:!0});class c{constructor(e={},t,s){this.wasmURL=new URL(e.wasmURL||"/static/js/vmsg.wasm",location).href,this.shimURL=new URL(e.shimURL||"/static/js/wasm-polyfill.js",location).href,this.pitch=e.pitch||0,this.resolve=t,this.reject=s,this.backdrop=null,this.popup=null,this.recordBtn=null,this.stopBtn=null,this.timer=null,this.audio=null,this.saveBtn=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.tid=0,this.start=0,Object.seal(this),this.initAudio().then(()=>this.drawInit()).then(e=>this.initWorker(e)).then(()=>this.drawAll()).catch(e=>this.drawError(e))}drawInit(){if(this.backdrop)return;const e=this.backdrop=document.createElement("div");e.className="vmsg-backdrop",e.addEventListener("click",()=>this.close(null));const t=this.popup=document.createElement("div");t.className="vmsg-popup",t.addEventListener("click",e=>e.stopPropagation());const s=document.createElement("div");s.className="vmsg-progress";for(let n=0;n<3;n++){const e=document.createElement("div");e.className="vmsg-progress-dot",s.appendChild(e)}t.appendChild(s),e.appendChild(t),document.body.appendChild(e)}drawTime(e){const t=Math.round(e/1e3);this.timer.textContent=s(t/60)+":"+s(t%60)}drawAll(){this.drawInit(),this.clearAll();const e=document.createElement("div");e.className="vmsg-record-row",this.popup.appendChild(e);const t=this.recordBtn=document.createElement("button");t.className="vmsg-button vmsg-record-button",t.textContent="●",t.addEventListener("click",()=>this.startRecording()),e.appendChild(t);const s=this.stopBtn=document.createElement("button");s.className="vmsg-button vmsg-stop-button",s.style.display="none",s.textContent="■",s.addEventListener("click",()=>this.stopRecording()),e.appendChild(s);const n=this.audio=new Audio;n.autoplay=!0;const o=this.timer=document.createElement("span");o.className="vmsg-timer",o.addEventListener("click",()=>{n.paused?this.blobURL&&(n.src=this.blobURL):n.pause()}),this.drawTime(0),e.appendChild(o);const i=this.saveBtn=document.createElement("button");i.className="vmsg-button vmsg-save-button",i.textContent="✓",i.disabled=!0,i.addEventListener("click",()=>this.close(this.blob)),e.appendChild(i);const r=document.createElement("div");r.className="vmsg-slider-wrapper vmsg-gain-slider-wrapper";const a=document.createElement("input");a.className="vmsg-slider vmsg-gain-slider",a.setAttribute("type","range"),a.min=0,a.max=2,a.step=.2,a.value=1,a.onchange=(()=>{const e=+a.value;this.gainNode.gain.value=e}),a.onchange(),r.appendChild(a),this.popup.appendChild(r);const l=document.createElement("div");l.className="vmsg-slider-wrapper vmsg-pitch-slider-wrapper";const c=document.createElement("input");c.className="vmsg-slider vmsg-pitch-slider",c.setAttribute("type","range"),c.min=-1,c.max=1,c.step=.2,c.value=this.pitch,c.onchange=(()=>{const e=+c.value;this.pitchFX.setPitchOffset(e),this.gainNode.disconnect(),0===e?this.gainNode.connect(this.encNode):this.gainNode.connect(this.pitchFX.input)}),c.onchange(),l.appendChild(c),this.popup.appendChild(l)}drawError(e){console.error(e),this.drawInit(),this.clearAll();const t=document.createElement("div");t.className="vmsg-error",t.textContent=e.toString(),this.popup.appendChild(t)}clearAll(){this.popup&&(this.popup.innerHTML="")}close(e){this.audio&&this.audio.pause(),this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.audioCtx&&this.audioCtx.close(),this.worker&&this.worker.terminate(),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL),this.tid&&clearTimeout(this.tid),this.backdrop.remove(),e?this.resolve(e):this.reject(new Error("No record made"))}initAudio(){return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(e){return navigator.mediaDevices.getUserMedia(e)}:function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise(function(s,n){t.call(navigator,e,s,n)}):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then(e=>{const t=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),s=t.createMediaStreamSource(e),n=this.gainNode=(t.createGain||t.createGainNode).call(t);s.connect(n);const o=this.pitchFX=new l(t),i=this.encNode=(t.createScriptProcessor||t.createJavaScriptNode).call(t,0,1,1);o.output.connect(i)})}initWorker(e){const t=new Blob(["(",o.toString(),")()"],{type:"application/javascript"}),s=this.workerURL=URL.createObjectURL(t),n=this.worker=new Worker(s),{wasmURL:i,shimURL:r}=this;return n.postMessage({type:"init",data:{wasmURL:i,shimURL:r}}),new Promise((e,t)=>{n.onmessage=(s=>{const n=s.data;switch(n.type){case"init":e();break;case"init-error":t(new Error(n.data));break;case"error":case"internal-error":console.error("Worker error:",n.data);break;case"stop":this.blob=n.data,this.blobURL=URL.createObjectURL(n.data),this.recordBtn.style.display="",this.stopBtn.style.display="none",this.stopBtn.disabled=!1,this.saveBtn.disabled=!1}})})}startRecording(){this.audio.pause(),this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.start=n(),this.updateTime(),this.recordBtn.style.display="none",this.stopBtn.style.display="",this.saveBtn.disabled=!0,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=(e=>{const t=e.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:t})}),this.encNode.connect(this.audioCtx.destination)}stopRecording(){clearTimeout(this.tid),this.tid=0,this.stopBtn.disabled=!0,this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.worker.postMessage({type:"stop",data:null})}updateTime(){this.drawTime(n()-this.start),this.tid=setTimeout(()=>this.updateTime(),300)}}let d=!1;t.record=i,t.default={record:i};const u=.1,h=.05,p=.1;l.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},l.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(u*Math.abs(e))}}),define("ts/mod/forms/common",["require","exports","ts/mod/index","ts/mod/index","ts/alerts/index","ts/lang/index","ts/ui/index","ts/util/index"],function(e,t,s,n,o,i,r,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class l extends r.FormView{remove(){super.remove(),n.accountPanel.toggleMenu(!0)}handle403(){this.remove(),s.reset(),o.showAlert(i.default.ui.sessionExpired)}render(){n.accountPanel.toggleMenu(!1),n.accountPanel.el.append(this.el),this.initCaptcha()}renderPublicForm(e){return __awaiter(this,void 0,void 0,function*(){const t=yield a.uncachedGET(e);switch(t.status){case 200:this.el.append(a.makeFrag(yield t.text())),this.render();break;case 403:this.handle403();break;default:throw yield t.text()}})}postResponse(e,t){return __awaiter(this,void 0,void 0,function*(){const s={};this.injectCaptcha(s),t(s),yield this.handlePostResponse(yield a.postJSON(e,s))})}handlePostResponse(e){return __awaiter(this,void 0,void 0,function*(){switch(e.status){case 200:this.remove();break;case 403:this.handle403();break;default:this.renderFormResponse(yield e.text())}})}extractForm(e){const t=this.el.querySelectorAll("input[name], select[name], textarea[name]");for(const s of t){let t;switch(s.type){case"submit":case"button":continue;case"checkbox":t=s.checked;break;case"number":t=parseInt(s.value,10);break;default:t=s.value}e[s.name]=t}for(const s of this.el.querySelectorAll(".map-form")){const t=s.querySelectorAll(".map-field");if(!t.length)continue;const n={};for(let e=0;e<t.length;e+=2)n[t[e].value]=t[e+1].value;e[s.getAttribute("name")]=n}for(const s of this.el.querySelectorAll(".array-form")){const t=[...s.querySelectorAll(".array-field")];t.length&&(e[s.getAttribute("name")]=t.map(e=>e.value))}return e}}t.AccountForm=l}),define("ts/mod/forms/boards",["require","exports","ts/base/index","ts/util/index","ts/mod/forms/common"],function(e,t,s,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i extends s.View{constructor(e){super({tag:"form"}),this.parent=e,this.on("submit",e=>this.onSubmit(e)),this.render()}render(){return __awaiter(this,void 0,void 0,function*(){const e=yield n.uncachedGET(`/html/owned-boards`);switch(e.status){case 200:this.el.append(n.makeFrag(yield e.text())),this.parent.el.append(this.el);break;case 403:this.parent.handle403();break;default:throw yield e.text()}})}onSubmit(e){e.preventDefault(),e.stopPropagation();const t=e.target.querySelector("select").value;this.parent.renderNext(t),this.parent.board=t,this.remove()}}class r extends o.AccountForm{constructor(e){e.tag="form",super(e),this.boardSelector=new i(this),this.render()}}class a extends r{constructor(){super({class:"wide-fields"})}renderNext(e){return __awaiter(this,void 0,void 0,function*(){const t=yield n.postJSON(`/html/configure-board/${e}`,null);switch(t.status){case 200:const e=n.makeFrag(yield t.text());this.el.append(e),this.initCaptcha();break;case 403:this.handle403();break;default:throw yield t.text()}})}send(){this.postResponse(`/api/configure-board/${this.board}`,e=>this.extractForm(e))}}t.BoardConfigForm=a;class l extends r{constructor(){super({})}renderNext(e){this.renderPublicForm("/html/captcha")}send(){this.postResponse("/api/delete-board",e=>e.board=this.board)}}t.BoardDeletionForm=l;class c extends r{constructor(){super({class:"divide-rows"})}renderNext(e){this.renderPublicForm(`/html/assign-staff/${e}`)}send(){this.postResponse("/api/assign-staff",e=>{e.board=this.board,this.extractForm(e)})}}t.StaffAssignmentForm=c;class d extends r{constructor(){super({})}renderNext(e){this.renderPublicForm("/html/set-banners")}send(){return __awaiter(this,void 0,void 0,function*(){const e=new FormData(this.el);if(e.append("board",this.board),this.captcha){const t=this.captcha.data();for(const s of Object.keys(t))e.append(s,t[s])}this.handlePostResponse(yield fetch("/api/set-banners",{body:e,credentials:"include",method:"POST"}))})}}t.BannerForm=d;class u extends o.AccountForm{constructor(){super({tag:"form"}),this.renderPublicForm("/html/create-board")}send(){this.postResponse("/api/create-board",e=>{e.id=this.inputElement("boardName").value,e.title=this.inputElement("boardTitle").value})}}t.BoardCreationForm=u}),define("ts/mod/forms/password",["require","exports","ts/mod/index","ts/mod/forms/common"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o extends n.AccountForm{constructor(){super({tag:"form"}),this.renderPublicForm("/html/change-password").then(()=>s.validatePasswordMatch(this.el,"newPassword","repeat"))}send(){this.postResponse("/api/change-password",e=>{e.old=this.inputElement("oldPassword").value,e.new=this.inputElement("newPassword").value})}}t.PasswordChangeForm=o}),define("ts/mod/forms/server",["require","exports","ts/util/index","ts/mod/forms/common"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class o extends n.AccountForm{constructor(){super({class:"wide-fields",tag:"form"}),this.render()}render(){const e=e=>super[e];return __awaiter(this,void 0,void 0,function*(){const t=yield fetch("/html/configure-server",{credentials:"include",method:"POST"});switch(t.status){case 200:this.el.append(s.makeFrag(yield t.text())),e("render").call(this);break;case 403:this.handle403();break;default:throw yield t.text()}})}send(){this.postResponse("/api/configure-server",e=>this.extractForm(e))}}t.ServerConfigForm=o}),define("ts/mod/forms/index",["require","exports","ts/mod/forms/boards","ts/mod/forms/password","ts/mod/forms/server"],function(e,t,s,n,o){"use strict";function i(e){for(var s in e)t.hasOwnProperty(s)||(t[s]=e[s])}Object.defineProperty(t,"__esModule",{value:!0}),i(s),i(n),i(o)}),define("ts/mod/index",["require","exports","ts/alerts/index","ts/api/index","ts/base/index","ts/lang/index","ts/state/index","ts/ui/index","ts/util/index","ts/vars/index","ts/mod/forms/index"],function(e,t,s,n,o,i,r,a,l,c,d){"use strict";function u(e,t,s){const n=l.inputElement(e,t),o=l.inputElement(e,s);n.onchange=o.onchange=(()=>{const e=o.value!==n.value?i.default.ui.mustMatch:"";o.setCustomValidity(e)})}function h(){t.LoginID.delete()}function p(e){return __awaiter(this,void 0,void 0,function*(){const t=yield fetch(e,{credentials:"include",method:"POST"});switch(t.status){case 200:case 403:h(),location.reload(!0);break;default:s.showAlert(yield t.text())}})}function f(e){return r.getModel(e.target)}function m(e,t){(t||confirm(i.ln.UI.delConfirm))&&n.default.post.delete([e.id]).then(()=>{r.page.thread||e.setDeleted()},s.showAlert)}function g(e){if(!confirm(i.ln.UI.banConfirm))return;n.default.user.banByPost({duration:525600,global:t.position>=4,ids:[e.id],reason:"default"}).then(()=>{m(e,!0)}).catch(s.showAlert)}Object.defineProperty(t,"__esModule",{value:!0}),t.position=window.position,t.isStaff=function(){return t.position>0},t.getMyAuth=function(){switch(t.position){case 4:return"admin";case 3:return"owners";case 2:return"moderators";case 1:return"janitors";default:return""}},t.validatePasswordMatch=u;let A,b;class y extends o.TabbedModal{constructor(){if(super(document.getElementById("account-panel")),this.onClick({"#logout":()=>p("/api/logout"),"#logoutAll":()=>p("/api/logout/all"),"#changePassword":this.loadConditional(d.PasswordChangeForm),"#createBoard":this.loadConditional(d.BoardCreationForm),"#configureBoard":this.loadConditional(d.BoardConfigForm),"#assignStaff":this.loadConditional(d.StaffAssignmentForm),"#setBanners":this.loadConditional(d.BannerForm),"#deleteBoard":this.loadConditional(d.BoardDeletionForm),"#configureServer":this.loadConditional(d.ServerConfigForm)}),-1===t.position)this.tabHook=(e=>{switch(e){case 0:A.initCaptcha();break;case 1:b.initCaptcha()}}),this.showHook=(()=>{A.initCaptcha()});else{const e=document.getElementById("logout");e.textContent+=`, ${t.LoginID.get()}`}}toggleMenu(e){document.getElementById("form-selection").style.display=e?"block":"none"}loadConditional(e){return()=>{this.toggleMenu(!1),new e}}}t.LoginID={get:()=>localStorage.loginID,set(e){localStorage.loginID=e},delete(){delete localStorage.loginID}},t.reset=h;class w extends a.FormView{constructor(e,t){super({el:document.getElementById(e),lazyCaptcha:!0}),this.url="/api/"+t,this.login="login"===t}send(){return __awaiter(this,void 0,void 0,function*(){const e=this.inputElement("id").value.trim(),s={id:e,password:this.inputElement("password").value};this.injectCaptcha(s);const n=yield l.postJSON(this.url,s);switch(n.status){case 200:this.login&&t.LoginID.set(e),location.reload(!0);default:this.renderFormResponse(yield n.text())}})}}t.init=function(){t.accountPanel=new y,-1===t.position&&(A=new w("login-form","login"),u((b=new w("registration-form","register")).el,"password","repeat")),t.position>0&&(l.on(document,"click",e=>{m(f(e))},{selector:c.TRIGGER_DELETE_POST_SEL}),l.on(document,"click",e=>{g(f(e))},{selector:c.TRIGGER_BAN_BY_POST_SEL}))}}),define("ts/posts/signature",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=["slice","Jje","replace","hXe","uUq","ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=","1|3|4|0|2","split","length","8|0|4|2|1|3|6|7|5","charCodeAt","IhO","REM","ENb","GUt","xYS","fHI","charAt","ekq","ANy","pPC","position","zUt","WoB","stringify","boards"];!function(e,t){!function(t){for(;--t;)e.push(e.shift())}(++t)}(s,161);var n=function(e,t){return s[e-=0]};t.gen=function(e){function t(e){for(var t={NnD:function(e,t){return e<t},IhO:function(e,t){return e|t},REM:function(e,t){return e<<t},ENb:function(e,t){return e&t},GUt:function(e,t){return e>>t},QjK:function(e,t){return e+t},xYS:function(e,t){return e+t},fHI:function(e,t){return e+t},ekq:function(e,t){return e(t)}},s=n("0x1")[n("0x2")]("|"),i=0;[];){switch(s[i++]){case"0":for(;t.NnD(g,e[n("0x3")]);)for(var r=n("0x4")[n("0x2")]("|"),a=0;[];){switch(r[a++]){case"0":d=e[n("0x5")](g++);continue;case"1":p=t[n("0x6")](t[n("0x7")](t[n("0x8")](c,3),4),t[n("0x9")](d,4));continue;case"2":h=t[n("0x9")](c,2);continue;case"3":f=t[n("0x6")](t[n("0x7")](t.ENb(d,15),2),t.GUt(u,6));continue;case"4":u=e[n("0x5")](g++);continue;case"5":l=t.QjK(t[n("0xa")](t.fHI(t[n("0xb")](l,o[n("0xc")](h)),o.charAt(p)),o[n("0xc")](f)),o[n("0xc")](m));continue;case"6":m=t.ENb(u,63);continue;case"7":t[n("0xd")](isNaN,d)?f=m=64:t.ekq(isNaN,u)&&(m=64);continue;case"8":c=e.charCodeAt(g++);continue}break}continue;case"1":var l="";continue;case"2":return l;case"3":var c,d,u,h,p,f,m;continue;case"4":var g=0;continue}break}}for(var s={ANy:function(e,t){return e-t},pPC:function(e,t){return e*t},zUt:function(e,t){return e(t)},WoB:function(e,t){return e+t},Jje:function(e,t){return e(t)},hXe:function(e,t){return e-t},uUq:function(e,t){return e<t},KWB:function(e,t){return e&t}},o=n("0x0"),i=s[n("0xe")](s[n("0xe")](s[n("0xf")](window[n("0x10")],2),window[n("0x10")]),window[n("0x10")]),r=s[n("0x11")](t,s[n("0x12")](JSON[n("0x13")](window[n("0x14")])[n("0x15")](i,i),s[n("0x16")](t,e)))[n("0x17")](/=/g,""),a=r[n("0x3")],l=0,c=0,d=s[n("0x18")](a,1),u="";s[n("0x19")](l,a);++l)s.KWB(l,1)?u+=r[d--]:u+=r[c++];return u}}),define("ts/posts/smile-box",["require","exports","classnames","preact","textarea-caret","smiles-pp/smiles","ts/util/index"],function(e,t,s,n,o,i,r){"use strict";function a(e){return e>=g&&e<=A||e>=b&&e<=y||e===w}function l(e){return f.has(e)}function c(e){return m.has(e)}function d(e){return!l(e)&&!c(e)}function u(){try{I=JSON.parse(localStorage.recentSmiles)}catch(e){}}function h(e){I=r.rotateRecent(I,e,L),localStorage.recentSmiles=JSON.stringify(I)}Object.defineProperty(t,"__esModule",{value:!0});const p=Array.from(i.default).sort(),f=new Set(`\n  chips coffee cola corvalol goose gun gun2 heart heart2 heart3 heart4\n  karandash knife nogoose ovsyanka popcorn prev ramyun rope soju pringles\n`.trim().split(/\s+/)),m=new Set(`\n  beast cool frukt heechul hyunsuk jyp jyp2 kwangsoo lookup priunil sooman\n  tellmemore v_gugudalnik sekshie plsno orly police autism hyperlol iljin\n  blinchick hug shy\n`.trim().split(/\s+/)),g=97,A=122,b=48,y=57,w=95,v=58,_=32,x=10,k=27,S=37,E=39,P=38,C=40,T=36,M=35,O=13,L=8;let I=[];window.addEventListener("storage",u),u(),t.autocomplete=function(e){const t=e.selectionStart,s=e.selectionEnd;if(t!==s)return null;if(s<4)return null;const n=e.value,o=s<n.length?n.charCodeAt(s):0;if(o&&o!==_&&o!==x)return null;let i=s-1,l="",c=!1;for(;i>=0;i--){const e=n.charCodeAt(i);if(!a(e)){if(e===v){c=!0;break}return null}if((l+=n[i]).length>10)return null}if(!c)return null;if(l.length<3)return null;const d=i>0?n.charCodeAt(i-1):0;if(d&&d!==_&&d!==x)return null;l=r.reverse(l);const u=p.filter(e=>e.includes(l));return u.length?u:null};class R extends n.Component{constructor(){super(...arguments),this.state={left:0,top:0,cur:0},this.listEl=null,this.handleGlobalKey=(e=>{e.keyCode===k?this.props.onClose():e.target===this.props.textarea&&this.handleBodyKey(e)}),this.handleGlobalClick=(e=>{0===e.button&&this.props.onClose()}),this.handleBodyKey=(e=>{const{acList:t}=this.props;if(!t)return;const s=t.length-1;let{cur:n}=this.state;e.keyCode===S?(e.preventDefault(),n=(n-=1)<0?s:n,this.setState({cur:n},this.scrollToSmile)):e.keyCode===E?(e.preventDefault(),n=(n+=1)>s?0:n,this.setState({cur:n},this.scrollToSmile)):e.keyCode===O?(e.preventDefault(),this.handleSmileSelect(t[n])):e.keyCode!==T&&e.keyCode!==M&&e.keyCode!==P&&e.keyCode!==C||this.props.onClose()}),this.handleIgnore=(e=>{e.stopPropagation()}),this.handleSmileOver=(e=>{this.setState({cur:e})}),this.handleSmileSelect=(e=>{h(e),this.props.onSelect(e)})}componentWillMount(){this.setAutocompletePos()}componentDidMount(){document.addEventListener("keydown",this.handleGlobalKey),document.addEventListener("click",this.handleGlobalClick)}componentWillUnmount(){document.removeEventListener("keydown",this.handleGlobalKey),document.removeEventListener("click",this.handleGlobalClick)}componentWillReceiveProps({body:e,acList:t}){e!==this.props.body&&this.setAutocompletePos(),t!==this.props.acList&&this.setState({cur:0},this.scrollToSmile)}setAutocompletePos(){if(this.props.acList){const e=this.props.textarea;let{left:t,top:s}=o(e,e.selectionEnd);s-=e.scrollTop,t+=5,s-=35;const n=this.props.wrapper.getBoundingClientRect(),i=e.getBoundingClientRect();t+=i.left-n.left,s+=i.top-n.top,this.setState({left:t,top:s})}}scrollToSmile(){const e=this.listEl,t=e.children[this.state.cur];(t.offsetLeft<e.scrollLeft||t.offsetLeft+t.offsetWidth>e.offsetWidth+e.scrollLeft)&&(e.scrollLeft=t.offsetLeft)}render({acList:e},{left:t,top:o}){const i=e?{left:t,top:o}:null;return n.h("div",{class:s("smile-box",{"smile-box_full":!e,"smile-box_autocomplete":!!e}),style:i,onMouseDown:this.handleIgnore,onMouseMove:this.handleIgnore,onClick:this.handleIgnore},n.h("div",{class:"smiles",ref:r.setter(this,"listEl")},!e&&I.length?this.renderRecent():null,e?this.renderList(e):this.renderAll()))}renderRecent(){return[n.h("div",{class:"smiles-group"},this.renderList(I)),n.h("hr",{class:"separator smiles-separator"})]}renderAll(){return[n.h("div",{class:"smiles-group"},this.renderList(p.filter(l))),n.h("hr",{class:"separator smiles-separator"}),n.h("div",{class:"smiles-group"},this.renderList(p.filter(c))),n.h("hr",{class:"separator smiles-separator"}),n.h("div",{class:"smiles-group"},this.renderList(p.filter(d)))]}renderList(e){const t=this.props.acList?this.state.cur:-1;return e.map((e,o)=>n.h("div",{class:s("smiles-item",{"smiles-item_cur":o===t})},n.h("i",{class:s("smile",`smile-${e}`,"smiles-icon"),title:`:${e}:`,onMouseOver:this.handleSmileOver.bind(null,o),onClick:this.handleSmileSelect.bind(null,e)})))}}t.default=R}),define("ts/posts/reply",["require","exports","classnames","preact","node_modules/vmsg/vmsg","ts/alerts/index","ts/api/index","ts/lang/index","ts/mod/index","ts/state/index","ts/templates/index","ts/util/index","ts/vars/index","ts/posts/signature","ts/posts/smile-box"],function(e,t,s,n,o,i,r,a,l,c,d,u,h,p,f){"use strict";function m(e){return e.trim().split(/\n/).filter(e=>!!e).map(e=>">"+e).join("\n")}function g(e){return new Promise((t,s)=>{const n=document.createElement("video"),o=URL.createObjectURL(e);n.muted=!0,n.onloadeddata=(()=>{const{videoWidth:e,videoHeight:i,duration:r}=n;if(!e||!i)return void s(new Error);const a=document.createElement("canvas"),l=a.getContext("2d");a.width=e,a.height=i,l.drawImage(n,0,0,e,i);const c=a.toDataURL();t({width:e,height:i,dur:r,src:o,thumb:c})}),n.onerror=s,n.src=o})}function A(e){return new Promise((t,s)=>{const n=new Audio,o=URL.createObjectURL(e);n.muted=!0,n.onloadeddata=(()=>{const{duration:e}=n;t({dur:e,src:o})}),n.onerror=s,n.src=o})}function b(e,t){return new Promise((s,n)=>{const o=URL.createObjectURL(e);let i=o;const r=new Image;r.onload=(()=>{const{width:e,height:n}=r;if(t)return void s({width:e,height:n,src:o,thumb:i});const a=document.createElement("canvas"),l=a.getContext("2d");a.width=e,a.height=n,l.drawImage(r,0,0,e,n),i=a.toDataURL(),s({width:e,height:n,src:o,thumb:i})}),r.onerror=n,r.src=o})}function y(e){let t=null,s=!1;return e.type.startsWith("video/")?t=g:e.type.startsWith("audio/")&&e.record?t=A:(t=b,"image/gif"!==e.type&&(s=!0)),t(e,s)}function w(e){return e.touches?e.touches[0].clientX:e.clientX}function v(e){return e.touches?e.touches[0].clientY:e.clientY}Object.defineProperty(t,"__esModule",{value:!0});class _ extends n.Component{render(e){const t=!!e.file.record,{thumb:s}=e.info,o=this.renderInfo();return n.h("div",{class:"reply-file"},n.h("a",{class:"control reply-remove-file-control",onClick:e.onRemove},n.h("i",{class:"fa fa-remove"})),n.h(u.ShowHide,{show:!t},n.h("img",{class:"reply-file-thumb",src:s})),n.h(u.ShowHide,{show:t},n.h("div",{class:"reply-file-thumb reply-file-thumb_record"},n.h("i",{class:"reply-file-thumb-icon fa fa-music"}))),n.h("div",{class:"reply-file-info",title:o},o))}renderInfo(){const{size:e}=this.props.file,{width:t,height:s,dur:n}=this.props.info,o=[];return(t||s)&&o.push(`${t}×${s}`),o.push(d.fileSize(e)),n&&o.push(d.duration(Math.round(n))),o.join(", ")}}class x extends n.Component{shouldComponentUpdate({body:e}){return e!==this.props.body}render({body:e}){const t={body:e},s=d.renderBody(t);return n.h("div",{class:"reply-body reply-message",dangerouslySetInnerHTML:{__html:s}})}}class k extends n.Component{constructor(){super(...arguments),this.state={float:!1,left:0,top:0,width:c.page.thread?h.REPLY_THREAD_WIDTH_PX:h.REPLY_BOARD_WIDTH_PX,height:h.REPLY_HEIGHT_PX,pos:"i",editing:!0,sending:!1,progress:0,board:"all"===c.page.board?c.boards[0].id:c.page.board,thread:c.page.thread,subject:"",body:"",smileBox:!1,smileBoxAC:null,fwraps:[],staffTitle:!1},this.mainEl=null,this.bodyEl=null,this.fileEl=null,this.sendAPI={},this.moving=!1,this.resizing=!1,this.baseX=0,this.baseY=0,this.startX=0,this.startY=0,this.startW=0,this.startH=0,this.focus=(()=>{this.bodyEl&&this.bodyEl.focus()}),this.focusAndScroll=(()=>{this.focus(),this.bodyEl&&(c.page.thread?this.state.float||this.bodyEl.scrollIntoView():u.scrollToTop())}),this.pasteBold=(()=>this.pasteMarkup("**")),this.pasteItalic=(()=>this.pasteMarkup("*")),this.pasteSpoiler=(()=>this.pasteMarkup("%%")),this.handleGlobalMove=(e=>{if(this.moving)this.setState({float:!0,left:this.startX+w(e)-this.baseX,top:this.startY+v(e)-this.baseY});else if(this.resizing){const{pos:t}=this.state,s=w(e)-this.baseX,n=v(e)-this.baseY;let{startW:o,startH:i,startX:r,startY:a}=this;switch(t){case"nw":r+=s,o-=s,a+=n,i-=n;break;case"se":o+=s,i+=n;break;case"ne":o+=s,a+=n,i-=n;break;case"sw":r+=s,o-=s,i+=n;break;case"n":a+=n,i-=n;break;case"s":i+=n;break;case"e":o+=s;break;case"w":r+=s,o-=s}o<this.minWidth&&("nw"===t||"sw"===t||"w"===t)&&(r-=this.minWidth-o),i<this.minHeight&&("nw"===t||"ne"===t||"n"===t)&&(a-=this.minHeight-i),o=Math.max(o,this.minWidth),i=Math.max(i,this.minHeight),this.setState({width:o,height:i,left:r,top:a})}}),this.handleGlobalUp=(()=>{this.moving=!1,this.resizing=!1}),this.handleMoveDown=(e=>{e.preventDefault(),this.moving=!0,this.saveCoords(e)}),this.handleFormDown=(e=>{"i"!==this.state.pos&&(e.preventDefault(),this.resizing=!0,this.saveCoords(e))}),this.handleFormMove=(e=>{if(this.resizing)return;const t=this.mainEl.getBoundingClientRect(),s=t.width,n=t.height,o=e.clientX-t.left,i=e.clientY-t.top;let r="i";o<=5&&i<=5?r="nw":o<=5&&i>=n-5?r="sw":o>=s-5&&i<=5?r="ne":o>=s-5&&i>=n-5?r="se":o<=5?r="w":i<=5?r="n":o>=s-5?r="e":i>=n-5&&(r="s"),this.setState({pos:r})}),this.handleFormPin=(()=>{this.setState({float:!1},this.focus)}),this.handleFormHide=(()=>{this.props.onHide()}),this.handleSubjectChange=(e=>{this.setState({subject:e.target.value})}),this.handleBoardChange=(e=>{this.setState({board:e.target.value})}),this.handleBodyChange=(e=>{const t=f.autocomplete(this.bodyEl),s=!!t;this.setState({body:e.target.value,smileBox:s,smileBoxAC:t})}),this.handleAttach=(()=>{this.fileEl.click()}),this.handleRecord=(()=>{let e=2*Math.random()-1;e>-.2&&e<.2&&(e=.2),o.default.record({pitch:e}).then(e=>{e.record=!0,this.handleFiles([e])})}),this.handleAttachRemove=(e=>{if(this.state.sending)return;const t=this.state.fwraps.filter(t=>t.info.src!==e);this.setState({fwraps:t},this.focus)}),this.handleDrop=(e=>{e.length&&this.handleFiles(e)}),this.handleFileChange=(()=>{const e=this.fileEl.files;e.length&&this.handleFiles(e),this.fileEl.value=null}),this.handleFiles=(e=>{const t=Array.prototype.slice.call(e,0,c.config.maxFiles);u.collect(t.map(this.handleFile)).then(e=>{e=(e=this.state.fwraps.concat(e)).slice(Math.max(0,e.length-c.config.maxFiles)),this.setState({fwraps:e},this.focus)})}),this.handleFile=(e=>e.size>1024*c.config.maxSize*1024?(i.showAlert(a.ln.UI.tooBig),Promise.reject(new Error(a.ln.UI.tooBig))):y(e).then(t=>({file:e,info:t}),e=>{throw i.showAlert(a.ln.UI.unsupFile),e})),this.handleSend=(()=>{if(this.disabled)return;const{board:e,thread:t,subject:s,body:n,staffTitle:o}=this.state,l=this.state.fwraps.map(e=>e.file),d=c.page.thread?r.default.post.create:r.default.thread.create;this.setState({sending:!0}),r.default.post.createToken().then(({id:i})=>{const r=p.gen(i);return d({board:e,thread:t,subject:s,body:n,files:l,staffTitle:o,token:i,sign:r},this.handleSendProgress,this.sendAPI)}).then(t=>{c.page.thread?(c.storeMine(t.id,c.page.thread),this.handleFormHide()):(c.storeMine(t.id,t.id),location.href=`/${e}/${t.id}`)},e=>{e instanceof u.AbortError||i.showAlert({title:a.ln.UI.sendErr,message:e.message})}).then(()=>{this.setState({sending:!1,progress:0}),this.sendAPI={}})}),this.handleSendProgress=(e=>{const t=Math.floor(e.loaded/e.total*100);this.setState({progress:t})}),this.handleSendAbort=(()=>{this.sendAPI.abort&&this.sendAPI.abort()}),this.handleToggleEditing=(()=>{const e=!this.state.editing;this.setState({editing:e,smileBox:!1},this.focus)}),this.handleToggleStaffTitle=(()=>{const e=!this.state.staffTitle;this.setState({staffTitle:e},this.focus)}),this.handleToggleSmileBox=(e=>{e.stopPropagation();const t=!!this.state.smileBoxAC||!this.state.smileBox;this.setState({smileBox:t,smileBoxAC:null})}),this.handleHideSmileBox=(()=>{this.setState({smileBox:!1})}),this.handleSmileSelect=(e=>{this.setState({smileBox:!1});const t=!!this.state.smileBoxAC;let s=0;if(t){let e=this.bodyEl.selectionEnd-1;for(;e>=0&&":"!==this.state.body[e];)e--,s++;s++}this.pasteMarkup(`:${e}:`,{mono:!0,nosep:t,offset:s})})}componentWillMount(){const{quoted:e,dropped:t}=this.props;e&&(this.quote(e),this.setFloat(e)),t&&this.handleDrop(t)}componentDidMount(){u.hook(0,this.focusAndScroll),u.hook(2,this.handleSend),u.hook(5,this.handleAttach),u.hook(6,this.handleToggleEditing),u.hook(7,this.pasteBold),u.hook(8,this.pasteItalic),u.hook(9,this.pasteSpoiler),document.addEventListener("mousemove",this.handleGlobalMove),document.addEventListener("touchmove",this.handleGlobalMove),document.addEventListener("mouseup",this.handleGlobalUp),document.addEventListener("touchend",this.handleGlobalUp),this.focusAndScroll();const e=this.state.body.length;this.bodyEl.setSelectionRange(e,e)}componentWillUnmount(){u.unhook(0,this.focusAndScroll),u.unhook(2,this.handleSend),u.unhook(5,this.handleAttach),u.unhook(6,this.handleToggleEditing),u.unhook(7,this.pasteBold),u.unhook(8,this.pasteItalic),u.unhook(9,this.pasteSpoiler),document.removeEventListener("mousemove",this.handleGlobalMove),document.removeEventListener("touchmove",this.handleGlobalMove),document.removeEventListener("mouseup",this.handleGlobalUp),document.removeEventListener("touchend",this.handleGlobalUp)}componentWillReceiveProps({quoted:e,dropped:t}){e!==this.props.quoted&&(e?this.quote(e):this.handleFormPin()),t!==this.props.dropped&&t&&this.handleDrop(t)}render({},{float:e,fwraps:t,staffTitle:o}){const i=t.length>1;return n.h("div",{ref:u.setter(this,"mainEl"),class:s("reply",{reply_float:e,reply_files:i,reply_mod:o}),style:this.style,onMouseDown:this.handleFormDown,onMouseMove:this.handleFormMove},n.h("div",{class:"reply-inner"},n.h("div",{class:"reply-content"},this.renderFiles(),n.h("div",{class:"reply-content-inner"},this.renderHeader(),this.renderBody())),this.renderSideControls()),this.renderFooterControls(),this.renderSmileBox(),n.h("input",{class:"reply-files-input",ref:u.setter(this,"fileEl"),type:"file",accept:"image/*,video/*",multiple:!0,onChange:this.handleFileChange}))}get cursor(){switch(this.state.pos){case"nw":case"se":return"nwse-resize";case"ne":case"sw":return"nesw-resize";case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";default:return"inherit"}}get minWidth(){return 400}get minHeight(){return this.state.fwraps.length>1?300:200}get style(){const{float:e,left:t,top:s,width:n}=this.state,o={width:n,height:Math.max(this.minHeight,this.state.height),cursor:this.cursor};return e&&(o.position="fixed",o.left=t,o.top=s),o}get invalid(){const{subject:e,body:t,fwraps:s}=this.state;return!(!!e||!!c.page.thread)||!t&&!s.length}get disabled(){const{sending:e}=this.state;return e||this.invalid}quote(e){const t=e.target.closest(h.POST_SEL),s=t.querySelector(h.POST_BODY_SEL),n=u.getID(t);let{body:o}=this.state,i=0,r=0;this.bodyEl&&(i=this.bodyEl.selectionStart,r=this.bodyEl.selectionEnd);let a="";const l=i>0?o[i-1]:"",c=!l||"\n"===l,d=r<o.length?o[r]:"",p=o.includes(">>"+n),f=window.getSelection(),g=m(f.toString()),A=!f.isCollapsed&&s.contains(f.anchorNode)&&s.contains(f.focusNode)&&!!g;A&&!c&&(a+="\n"),A||c||" "===l||(a+=" "),A&&p||(a+=`>>${n}`),A&&!p&&(a+="\n"),A&&(a+=g),(A||c)&&(a+="\n");const b=i+a.length;r<o.length&&(A||c?"\n"!==d&&(a+="\n"):" "!==d&&(a+=" ")),o=o.slice(0,i)+a+o.slice(r),this.setState({body:o},()=>{this.bodyEl&&null!==this.bodyEl.offsetParent&&(this.focus(),this.bodyEl.setSelectionRange(b,b))})}setFloat(e){const t=e.target.closest(h.POST_SEL).getBoundingClientRect(),s=window.innerWidth-this.state.width-10,n=h.HEADER_HEIGHT_PX+10,o=window.innerHeight-this.state.height-10,i=t.right+10,r=t.top,a=Math.max(0,Math.min(i,s)),l=Math.max(n,Math.min(r,o));this.setState({float:!0,left:a,top:l})}saveCoords(e){this.baseX=w(e),this.baseY=v(e);const t=this.mainEl.getBoundingClientRect();this.startX=t.left,this.startY=t.top,this.startW=t.width,this.startH=t.height}pasteMarkup(e,t){const{mono:s,nosep:n,offset:o}=t||{},i=this.bodyEl.selectionStart-(o||0),r=this.bodyEl.selectionEnd;let{body:a}=this.state;if(i<r&&!s){const t=a.slice(i,r);a=a.slice(0,i)+e+t+e+a.slice(r),this.setState({body:a},this.focus)}else{const t=i>0?a[i-1]:"",o=!t||"\n"===t||" "===t||n?"":" ",l=s?"":e;a=a.slice(0,i)+o+e+l+a.slice(r);const c=i+o.length+e.length;this.setState({body:a},()=>{this.focus(),this.bodyEl.setSelectionRange(c,c)})}}renderBoards(){if("all"!==c.page.board)return null;const{sending:e,board:t}=this.state;return n.h("select",{class:"reply-board",value:t,disabled:e,onInput:this.handleBoardChange},c.boards.map(({id:e})=>n.h("option",{class:"reply-board-item",key:e,value:e},e)))}renderFiles(){const{fwraps:e}=this.state;return n.h("div",{class:"reply-files"},e.map(({file:e,info:t})=>n.h(_,{key:t.src,info:t,file:e,onRemove:this.handleAttachRemove.bind(null,t.src)})))}renderHeader(){if(c.page.thread)return null;const{sending:e,subject:t}=this.state;return n.h("div",{class:"reply-header"},this.renderBoards(),n.h("input",{class:"reply-subject",placeholder:a.ln.UI.subject+"∗",value:t,disabled:e,onInput:this.handleSubjectChange}))}renderBody(){const{editing:e,sending:t,body:s}=this.state;return e?n.h("textarea",{class:"reply-body",ref:u.setter(this,"bodyEl"),value:s,disabled:t,onInput:this.handleBodyChange}):n.h(x,{body:s})}renderSideControls(){const{float:e,sending:t}=this.state;return n.h("div",{class:"reply-controls reply-side-controls"},n.h("div",{class:"reply-side-controls-inner"},n.h(u.ShowHide,{show:e},n.h("a",{class:"control reply-side-control reply-pin-control",onClick:this.handleFormPin},n.h("i",{class:"fa fa-thumb-tack"}))),n.h("button",{class:"control reply-side-control reply-hide-control",onClick:this.handleFormHide,disabled:t},n.h("i",{class:"fa fa-remove"}))),n.h("div",{class:"reply-dragger",onMouseDown:this.handleMoveDown,onTouchStart:this.handleMoveDown}))}renderFooterControls(){const{editing:e,sending:t,progress:o,staffTitle:i}=this.state,r=t?`${o}% (${a.ln.UI.clickToCancel})`:"";return n.h("div",{class:"reply-controls reply-footer-controls"},n.h("button",{class:"control reply-footer-control reply-attach-control",title:a.printf(a.ln.UI.attach,d.fileSize(1024*c.config.maxSize*1024)),disabled:t,onClick:this.handleAttach},n.h("i",{class:"fa fa-file-image-o"})),n.h("button",{class:"control reply-footer-control reply-record-control",title:a.ln.UI.record,disabled:t,onClick:this.handleRecord},n.h("i",{class:"fa fa-file-audio-o"})),n.h("button",{class:"control reply-footer-control reply-bold-control",title:a.ln.Forms.bold[0],disabled:!e||t,onClick:this.pasteBold},n.h("i",{class:"fa fa-bold"})),n.h("button",{class:"control reply-footer-control reply-italic-control",title:a.ln.Forms.italic[0],disabled:!e||t,onClick:this.pasteItalic},n.h("i",{class:"fa fa-italic"})),n.h("button",{class:"control reply-footer-control reply-spoiler-control",title:a.ln.Forms.spoiler[0],disabled:!e||t,onClick:this.pasteSpoiler},n.h("i",{class:"fa fa-eye-slash"})),n.h("button",{class:"control reply-footer-control reply-smile-control",title:a.ln.Forms.smile[0],disabled:!e||t,onClick:this.handleToggleSmileBox},n.h("i",{class:"reply-smile-icon"})),n.h("button",{class:"control reply-footer-control reply-edit-control",title:a.ln.Forms.previewPost[0],disabled:t,onClick:this.handleToggleEditing},n.h("i",{class:s("fa",e?"fa-print":"fa-pencil")})),n.h(u.ShowHide,{show:l.isStaff()},n.h("button",{class:s("control","reply-footer-control","reply-badge-control",{control_active:i}),title:a.ln.Forms.modBadge[0],disabled:t,onClick:this.handleToggleStaffTitle},n.h("i",{class:"fa fa-id-badge"}))),n.h("div",{class:"reply-dragger",onMouseDown:this.handleMoveDown,onTouchStart:this.handleMoveDown}),n.h(u.ShowHide,{show:!this.invalid},n.h(u.Progress,{className:"button reply-send-button",progress:o,title:r,onClick:t?this.handleSendAbort:this.handleSend},t?"":a.ln.UI.submit)))}renderSmileBox(){const{body:e,smileBox:t,smileBoxAC:s}=this.state;return t?n.h(f.default,{body:e,acList:s,wrapper:this.mainEl,textarea:this.bodyEl,onSelect:this.handleSmileSelect,onClose:this.handleHideSmileBox}):null}}class S extends n.Component{constructor(){super(...arguments),this.state={show:!1,quoted:null,dropped:null},this.handleHide=(()=>{this.setState({show:!1,quoted:null,dropped:null})})}componentDidMount(){u.hook(0,()=>{this.setState({show:!0})}),u.hook(1,this.handleHide),u.on(document,"click",()=>{this.setState({show:!0})},{selector:h.TRIGGER_OPEN_REPLY_SEL}),u.on(document,"click",e=>{this.setState({show:!0,quoted:e})},{selector:h.TRIGGER_QUOTE_POST_SEL}),u.on(document,"dragover",e=>{e.preventDefault()}),u.on(document,"drop",e=>{e.preventDefault();const t=e.dataTransfer.files;t.length&&this.setState({show:!0,dropped:t})})}render({},{show:e,quoted:t,dropped:s}){return n.h(u.ShowHide,{show:e},n.h(k,{quoted:t,dropped:s,onHide:this.handleHide}))}}t.init=function(){const e=document.querySelector(h.REPLY_CONTAINER_SEL);e&&n.render(n.h(S,null),e)}}),define("ts/posts/index",["require","exports","ts/posts/model","ts/posts/view","ts/posts/images","ts/posts/collection","ts/posts/hover","ts/options/index","ts/state/index","ts/util/index","ts/vars/index","ts/vars/index","ts/posts/hover","ts/posts/popup","ts/posts/reply"],function(e,t,s,n,o,i,r,a,l,c,d,u,h,p,f){"use strict";function m(){for(const{view:e}of l.posts)e.renderTime()}function g(){a.default.onChange("relativeTime",m),setInterval(()=>{a.default.relativeTime&&m()},1e3*d.RELATIVE_TIME_PERIOD_SECS)}function A(){c.on(document,"click",e=>{const t=e.target.textContent;c.copyToClipboard(t)},{selector:u.POST_FILE_TITLE_SEL})}Object.defineProperty(t,"__esModule",{value:!0}),t.Thread=s.Thread,t.Post=s.Post,t.PostView=n.default,t.thumbPath=o.thumbPath,t.sourcePath=o.sourcePath,t.PostCollection=i.default,t.isHoverActive=r.isOpen,t.init=function(){l.page.catalog||g(),A(),f.init(),h.init(),p.init()}}),define("ts/state/index",["require","exports","ts/db/index","ts/posts/index","ts/util/index"],function(e,t,s,n,o){"use strict";function i(){try{return JSON.parse(localStorage.mine)}catch(e){return[]}}function r(){const e=i();for(const s of e)t.mine.add(s)}Object.defineProperty(t,"__esModule",{value:!0}),t.getModel=function(e){const s=o.getClosestID(e);return s?t.posts.get(s):null},t.page=function(e){const t=document.createElement("a");t.href=e;let s=t.pathname;s.startsWith("/")||(s="/"+s);const n=s.match(/^\/\w+\/(\d+)/),o=t.search.match(/[&\?]page=(\d+)/);return{board:s.match(/^\/(\w+)?\/?/)[1],catalog:/^\/\w+\/catalog/.test(s),href:e,landing:"/"===s,stickers:s.startsWith("/stickers/"),lastN:/[&\?]last=100/.test(t.search)?100:0,page:o?parseInt(o[1],10):0,thread:parseInt(n&&n[1],10)||0}}(location.href),t.config=window.config,t.boards=window.boards,t.posts=new n.PostCollection,t.mine=new Set,t.loadPostStores=r,t.storeMine=function(e,n){t.mine.add(e);const o=Array.from(t.mine);localStorage.mine=JSON.stringify(o),s.setID("mine",e,n)},window.addEventListener("storage",r)}),define("ts/options/index",["require","exports","ts/state/index","ts/util/index"],function(e,t,s,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const o={workModeToggle:{default:!1,exec:e=>{document.documentElement.classList.toggle("work-mode",e)},type:0},popupBackdrop:{default:!0},imageHover:{default:!0},notification:{default:!1,exec(e){e&&"function"==typeof Notification&&"granted"!==Notification.permission&&Notification.requestPermission()}},relativeTime:{default:!0},scrollToBottom:{default:!0},theme:{get default(){return s.config.defaultCSS},exec(e){e&&document.getElementById("theme-css").setAttribute("href",`/static/css/${e}.css`)},noExecOnStart:!0,type:4},workMode:{default:65,type:3},newPost:{default:78,type:3},cancelPost:{default:67,type:3},selectFile:{default:79,type:3},previewPost:{default:69,type:3},bold:{default:66,type:3},italic:{default:73,type:3},spoiler:{default:80,type:3},volume:{default:1}},i=(()=>{const e={};for(const t of Object.keys(o))e[t]=void 0;return n.emitChanges(e)})();t.default=i,t.models={};class r{constructor(e,s){this.spec=s,this.id=e,s.type||(s.type=0);const n=i[this.id]=this.get();i.onChange(this.id,e=>this.onChange(e)),s.noExecOnStart||this.execute(n),t.models[this.id]=this}get(){const e=this.read();if(e){if("false"===e)return!1;if("true"===e)return!0;const t=+e;return t||0===t?t:e}return this.spec.default}execute(e){this.spec.exec&&this.spec.exec(e)}set(e){(e!==this.spec.default||this.read())&&localStorage.setItem(this.id,e.toString()),n.trigger("renderOptionValue",this.id,this.spec.type,e)}validate(e){return!this.spec.validation||this.spec.validation(e)}read(){return localStorage.getItem(this.id)||""}onChange(e){this.execute(e),this.set(e)}}t.init=function(){for(const e of Object.keys(o))new r(e,o[e])}}),define("ts/page/common",["require","exports","ts/lang/index","ts/posts/index","ts/state/index","ts/ui/index","ts/util/index","ts/vars/index"],function(e,t,s,n,o,i,r,a){"use strict";function l(e,t){for(const n of t.querySelectorAll(`a[data-id="${e}"]`))n.textContent+=` ${s.default.posts.you}`}function c(e){if(!e.links)return;let t,s=!1;for(const n of new Set(e.links.map(e=>e[0])))o.mine.has(n)&&(s=!0,t||(t=e.view.el.querySelector("blockquote")),l(n,t));s&&i.notifyAboutReply(e)}function d(e){if(!e.backlinks)return;let t;for(const s of Object.keys(e.backlinks)){const n=parseInt(s,10);o.mine.has(n)&&(t||(t=e.view.el.querySelector(a.POST_BACKLINKS_SEL)),l(n,t))}}Object.defineProperty(t,"__esModule",{value:!0}),t.isBanned=function(){return!!document.querySelector(".ban")},t.extractPageData=function(){return{threads:r.extractJSON("post-data"),backlinks:r.extractJSON("backlink-data")}},t.extractPost=function(e,t,s,r){const a=document.getElementById(`post${e.id}`);e.op=t,e.board=s;const l=new n.Post(e);if(o.posts.add(l),o.page.catalog)l.seenOnce=!0;else{const e=new n.PostView(l,a);e.afterRender(),l.backlinks=r[l.id],c(l),d(l),i.postAdded(l)}return!1}}),define("ts/page/thread",["require","exports","ts/page/common"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.render=function(){if(s.isBanned())return;const{threads:e,backlinks:t}=s.extractPageData(),{posts:n}=e;e.posts=null,s.extractPost(e,e.id,e.board,t);for(const o of n)s.extractPost(o,e.id,e.board,t)}}),define("ts/page/board",["require","exports","ts/state/index","ts/util/index","ts/vars/index","ts/page/common"],function(e,t,s,n,o,i){"use strict";function r(e){return(t,s)=>s[e]-t[e]}function a(){const{threads:e,backlinks:t}=i.extractPageData();for(const s of e)i.extractPost(s,s.id,s.board,t)}function l(){const{threads:e,backlinks:t}=i.extractPageData();for(const s of e){const{posts:e}=s;if(delete s.posts,i.extractPost(s,s.id,s.board,t))document.getElementById(`thread${s.id}`).remove();else for(const n of e)i.extractPost(n,s.id,s.board,t)}}function c(){let e="",t="";s.page.catalog?(e="catalog",t=".post-catalog-wrapper"):(e="index-thread-container",t=".thread");const n=document.getElementById(e),o=n.querySelectorAll(t);return[n,Array.from(o)]}function d(e){h(e.target.value)}function u(e){localStorage.setItem("catalogSort",e.target.value),p(!1)}function h(e){const[,t]=c(),o=new RegExp(e,"i"),i=new Set;for(const n of s.posts){const e=n.board&&o.test(`/${n.board}/`)||o.test(n.subject)||o.test(n.body);e&&i.add(n.op)}for(const s of t){const e=n.getID(s);s.style.display=i.has(e)?"":"none"}}function p(e){if(!s.page.catalog)return;const[t,o]=c(),i=localStorage.getItem("catalogSort")||"bump";if(e&&"bump"===i)return;const r={},a=o.map(e=>{const t=n.getID(e);return r[t]=e,s.posts.get(t)}).sort(f[i]).map(({id:e},t)=>{const s=r[e];return s.style.zIndex=(-t).toString(),s.remove(),s});t.append(...a)}Object.defineProperty(t,"__esModule",{value:!0});const f={bump:r("bumpTime"),creation:r("time"),fileCount:r("imageCtr"),replyCount:r("postCtr")};t.render=function(){s.page.catalog?a():l();const e=document.getElementById("threads");if(n.on(e,"input",d,{selector:o.BOARD_SEARCH_INPUT_SEL}),s.page.catalog){n.on(e,"input",u,{selector:o.BOARD_SEARCH_SORT_SEL});const t=e.querySelector(o.BOARD_SEARCH_SORT_SEL);t.value=localStorage.getItem("catalogSort")||"bump",p(!0)}}}),define("ts/page/index",["require","exports","ts/page/common","ts/page/thread","ts/page/board"],function(e,t,s,n,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isBanned=s.isBanned,t.renderThread=n.render,t.renderBoard=o.render}),define("app",["require","exports","ts/options/index","ts/alerts/index","ts/client/index","ts/connection/index","ts/db/index","ts/lang/index","ts/mod/index","ts/page/index","ts/posts/index","ts/state/index","ts/ui/index"],function(e,t,s,n,o,i,r,a,l,c,d,u,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(){return __awaiter(this,void 0,void 0,function*(){n.init(),yield r.init(),u.loadPostStores(),s.init(),u.page.landing||u.page.stickers||(u.page.thread?(c.renderThread(),i.init(),o.init()):c.renderBoard(),u.page.catalog||d.init()),h.init(),l.init()})}().catch(e=>{console.error(e),n.showAlert({message:e.message,sticky:!0,title:a.ln.UI.initErr})})}),define("cc-langs",["exports"],function(e){var t={};t.en={forms:{boardExpiry:["Board expiry time","Number of days without new posts before a board is deleted"],boardName:["Name","Name of the new board. Can contain up to 10 lowercase Latin letters or numbers."],boardTitle:["Title","Title of the new board, such as 'K-pop music'. Up to 100 characters long."],captcha:["Captcha","Ask users to complete a captcha for certain tasks like registration and thread creation"],defaultCSS:["Default theme","Theme to load by default, when none is set by the client"],defaultLang:["Default language","Language pack to load by default"],disableUserBoards:["Disable non-admin board creation","Prevents any account apart from the 'admin' account from creating new boards"],hideThumbs:["Hide thumbnails","Display a [Show] button in place of thumbnails"],id:["Login",""],popupBackdrop:["Popup backdrop","Close popups by clicking on background"],imageHover:["Media hover expansion","Display media previews on hover"],imageRootOverride:["Image root override","If you wish to host images from a separate location like a CDN, enter the full root address here. Leave empty to use the default address. Example: 'https://images.meguca.org'"],janitors:["Janitors","Janitor account IDs. Janitors can only delete posts."],lang:["Language","Change interface language"],maxSize:["Image size limit","Maximum size of uploaded images in MB"],maxFiles:["Files per post","Maximum number of files per post"],moderators:["Moderators","Moderator account IDs. Moderators can delete posts, ban posters and distinguish posters by their mnemonic IDs."],newPassword:["New password",""],newPost:["New post","Open reply form"],cancelPost:["Cancel post","Close reply form"],selectFile:["Select file","Open file select dialog"],bold:["Bold","Paste bold markup"],italic:["Italic","Paste italic markup"],spoiler:["Spoiler","Paste spoiler markup"],smile:["Paste smile",""],previewPost:["Preview post","Toggle post preview mode"],modBadge:["Show mod badge",""],notification:["Desktop Notifications","Get desktop notifications when quoted"],oldPassword:["Old password",""],owners:["Owners","Owner account IDs. Board owners have full access to all board controls. Must contain at least one."],password:["Password",""],pruneBoards:["Prune boards","Delete boards that have not had any new posts for N days"],pruneThreads:["Prune threads","Delete threads that have not had any posts in N days"],readOnly:["Read only","Disable post creation"],modOnly:["Mod only","Only for moderators"],register:["Register",""],relativeTime:["Relative Timestamps","Relative post timestamps. Ex.: '1 hour ago'"],scrollToBottom:["Scroll to bottom","Scroll page to bottom on new post"],repeat:["Repeat",""],rootURL:["Root URL","Root URL of the imageboard."],staffTitle:["Staff Title","Display your staff title in the post header"],theme:["Theme","Select CSS theme"],threadExpiryMax:["Maximal thread expiry time","Number of days without new posts before a thread is deleted"],threadExpiryMin:["Minimal thread expiry time","Number of days without new posts before a thread is deleted"],title:["Title","Short descriptive title of the board"],workMode:["Work mode","Hides images"],workModeToggle:["Work mode","Hides images"]},ui:{main:"Main page",notFound:"Page not found",landingHeader:"The only one k-pop imageboard",landingInfo:"",threads:"All threads",rules:"Rules",news:"News",stickers:"Stickers",clickToCancel:"Click to cancel upload",attach:"Attach file (%s max)",record:"Record voice message",tooBig:"Too big file",delConfirm:"Delete post?",banConfirm:"Delete post and ban author?",unsupFile:"Unsupported file type",unknownErr:"Unknown error",networkErr:"Network error",initErr:"Site load error",sendErr:"Send error",aggregator:"Aggregator metaboard",FAQ:"Information",account:"Account",add:"Add",apply:"Apply",assignStaff:"Assign staff",ban:"Ban",bannerSpecs:"Accepts up to 20 JPEG, PNG, GIF or WEBM files with maximum dimensions of 300x100, maximum file size of 100 KB and no sound.",by:"By",cancel:"Cancel",captcha:"Captcha",captchaID:"Captcha ID",catalog:"Catalog",changePassword:"Change password",clear:"Clear",configureBoard:"Configure board",configureServer:"Configure server",createBoard:"Create board",deleteImage:"Delete image",deletePost:"Delete post",deleteThread:"Delete thread",done:"Done",deleteBoard:"Delete board",expires:"Expires",global:"Global",loadCaptcha:"Click to load captcha",logout:"Logout",logoutAll:"Log out all devices",newThread:"New thread",notification:"Notification",options:"Options",ownNoBoards:"You don't own any boards",pointToCatalog:"Point to Catalog",post:"Post",posterID:"Poster ID",reply:"Reply",report:"Report",reason:"Reason",return:"Return",search:"Search",searchTooltip:"Filter threads by subject, body or board name encased in backslashes. Accepts Regular expressions.",setBanners:"Set banners",sortMode:"Sort threads by",subject:"Subject",submit:"Submit",sync:"Connection status",syncCount:"Unique connected IP count",text:"Text",time:"Time",type:"Type",unban:"Unban"},sortModes:["Bump time","Creation time","Reply count","File count"],tabs:["Options","Shortcuts"],templates:{banPage:["You have been banned from /%s/ for the reason:","Your ban will expire on %s or in %s."]},common:{posts:{clickToCopy:"Click to copy",ago:"ago",and:"and",banned:"USER WAS BANNED FOR THIS POST",contractImages:"Contract Images",deleteBySameIP:"Delete all by IP",expandImages:"Expand Images",expand:"Expand",hide:"Hide",in:"in",justNow:"just now",goToThread:"Go to thread",seeAll:"See all",show:"Show",you:"(You)",admin:"Admin",owners:"Board Owner",moderators:"Moderator",janitors:"Meido",viewBySameIP:"Same IP",toggleSticky:"Toggle sticky"},sizes:{b:"b",kb:"Kb",mb:"Mb"},plurals:{omitted:["omitted","omitted"],day:["day","days"],hour:["hour","hours"],image:["file","files"],minute:["minute","minutes"],month:["month","months"],post:["post","posts"],year:["year","years"]},time:{calendar:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],week:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},ui:{send:"Send",attach:"Attach",replies:"Replies",mustMatch:"Passwords must match",invalidCaptcha:"Invalid captcha",quoted:"You have been quoted",refresh:"Refresh",sessionExpired:"Login session expired",thumbnailing:"Thumbnailing…",unfinishedPost:"You have an unfinished post",uploadProgress:"uploaded…",last:"Last",finished:"Finished",confirmDelete:"Delete all posts by this IP?"}}},t.ru={forms:{boardExpiry:["Время жизни доски","Число дней без постов до автоудаления доски"],boardName:["Название","Имя новой доски, может содержать до 10 латинских букв и цифр в нижнем регистре"],boardTitle:["Заголовок","Заголовок новый доски, например «Корейская поп-музыка», максимум 100 символов"],captcha:["Капча","Заставлять пользователей вводить капчу для некоторых действий, например при регистрации и создании треда"],defaultCSS:["Тема по умолчанию","Используемая по умолчанию тема"],defaultLang:["Язык по умолчанию","Используемый по умолчанию язык"],disableUserBoards:["Запретить создание досок","Запретить всем, кроме админа, создавать новые доски"],hideThumbs:["Скрыть превью","Отображать кнопку [Показать] на месте превью"],id:["Логин",""],popupBackdrop:["Закрывать по нажатию на фон","Закрывать медиа-элементы по нажатию на фон"],imageHover:["Раскрывать при наведении","Отображать полные версии изображений при наведении мышью"],imageRootOverride:["Адрес сайта изображений","Для размещения изображений на отдельном сайте введите его полный адрес, например «https://images.example.com»"],janitors:["Помощники","Аккаунты помощников (могут только удалять посты)"],lang:["Язык","Изменить язык интерфейса"],maxSize:["Максимальный размер файла","Максимальный размер загружаемых файлов в мегабайтах"],maxFiles:["Число файлов на пост","Максимальное число файлов в посте"],moderators:["Модераторы","Аккаунты модераторов (могут удалять посты, банить и видеть ID постеров)"],newPassword:["Новый пароль",""],newPost:["Новый пост","Отобразить форму отправки"],cancelPost:["Отменить пост","Закрыть форму отправки"],selectFile:["Выбрать файл","Открыть диалог выбора файла"],bold:["Полужирный","Вставить полужирную разметку"],italic:["Курсив","Вставить разметку курсива"],spoiler:["Спойлер","Вставить разметку спойлера"],smile:["Вставить смайл",""],previewPost:["Предпросмотр поста","Переключить режим предпросмотра"],modBadge:["Отобразить лычку модератора",""],readOnly:["Только чтение","Запретить отправку постов"],modOnly:["Для модераторов","Доска только для модераторов"],notification:["Уведомления","Получать уведомления на рабочий стол при цитировании ваших постов"],oldPassword:["Старый пароль",""],owners:["Владельцы","Аккаунты владельцев доски (имеет доступ ко всем функциям доски, должен как хотя бы один)"],password:["Пароль",""],pruneBoards:["Автоочистка досок","Удалять доски на которых давно не было постов"],pruneThreads:["Автоочистка тредов","Удалять треды в которых давно не было постов"],register:["Регистрация",""],relativeTime:["Относительное время","Отображать относительное время постов, например «1 час назад»"],scrollToBottom:["Проматывать вниз","Проматывать страницу в низ при добавлении нового поста"],repeat:["Ещё раз",""],rootURL:["Адрес сайта","Корневой URL сайта"],staffTitle:["Метка модератора","Отображать модераторский статус в посте"],theme:["Тема сайта","Выбрать тему сайта"],threadExpiryMax:["Максимальное время жизни треда","Число дней без новых постов перед удалением треда"],threadExpiryMin:["Минимальное время жизни треда","Число дней без новых постов перед удалением треда"],title:["Заголовок","Короткий заголовок доски"],workMode:["Режим босса","Скрыть все изображения"],workModeToggle:["Режим босса","Скрыть все изображения"]},ui:{main:"Главная",notFound:"Страница не найдена",landingHeader:"Единственная в своём роде k-pop имиджборда",landingInfo:"kpop.re — это анонимный русскоязычный форум, посвященный корейской поп-музыке, где вы можете свободно обмениваться своим мнением с другими. Чтобы принять участие в обсуждениях, вам не нужно регистрироваться, необходимо просто открыть список тредов и выбрать понравившуюся вам тему.",threads:"Список тредов",rules:"Правила",news:"Новости",stickers:"Стикеры",clickToCancel:"Нажмите, чтобы отменить загрузку",attach:"Прикрепить файл (%s максимум)",record:"Записать голосовое сообщение",tooBig:"Файл слишком большой",delConfirm:"Удалить пост?",banConfirm:"Удалить пост и забанить автора?",unsupFile:"Неподдерживаемый тип файла",unknownErr:"Неизвестная ошибка",networkErr:"Ошибка сети",initErr:"Ошибка загрузки сайта",sendErr:"Ошибка отправки",aggregator:"Все доски",FAQ:"Информация о сайте",account:"Настройки аккаунта",add:"Добавить",apply:"Применить",assignStaff:"Назначить модератора",ban:"Бан",bannerSpecs:"Выберите не больше 20 JPG/PNG/GIF/WebM баннеров (макс. разрешение 300×100, макс. размер 100 Кб, без звука)",by:"Автор",cancel:"Отменить",captcha:"Капча",captchaID:"ID капчи",catalog:"Каталог",changePassword:"Изменить пароль",clear:"Очистить",configureBoard:"Настроить доску",configureServer:"Настроить борду",createBoard:"Создать доску",deleteImage:"Удалить изображение",deletePost:"Пост удалён",deleteThread:"Тред удалён",done:"Готово",deleteBoard:"Удалить доску",expires:"Истекает",global:"Глобальный",loadCaptcha:"Кликните для загрузки капчи",logout:"Выйти",logoutAll:"Очистить сессии",newThread:"Новый тред",notification:"Уведомление",options:"Настройки сайта",ownNoBoards:"Вы не владеете ни одной доской",pointToCatalog:"Перейти к каталогу",post:"Пост",posterID:"ID постера",reply:"Ответить",report:"Пожаловаться",reason:"Причина",return:"Назад",search:"Поиск",searchTooltip:"Фильтровать треды по теме, содержанию и имени доски (обрамлённую бэкслэшами), допустимы регулярные выражения",setBanners:"Добавить баннеры",sortMode:"Сортировать треды по",subject:"Тема",submit:"Отправить",sync:"Статус соединения",syncCount:"Количество уникальных подключённых IP",text:"Текст",time:"Время",type:"Тип",unban:"Разбан"},sortModes:["Время бампа","Время создания","Число ответов","Число файлов"],tabs:["Опции","Горячие клавиши"],templates:{banPage:["Вы были забанены на /%s/ по причине:","Ваш бан истечёт %s или через %s."]},common:{posts:{clickToCopy:"Нажмите, чтобы скопировать",ago:"назад",and:"и",banned:"USER WAS BANNED FOR THIS POST",contractImages:"Свернуть изображения",deleteBySameIP:"Удалить всё с этого IP",expandImages:"Развернуть изображения",expand:"Развернуть",hide:"Скрыть",in:"через",justNow:"только что",goToThread:"Перейти к треду",seeAll:"Показать все",show:"Показать",you:"(Вы)",admin:"Админ",owners:"Владелец доски",moderators:"Модератор",janitors:"Помощник",viewBySameIP:"Тот же IP",toggleSticky:"Прикрепить"},sizes:{b:"б",kb:"Кб",mb:"Мб"},plurals:{omitted:["пропущен","пропущено"],day:["день","дня","дней"],hour:["час","часа","часов"],image:["файл","файла","файлов"],minute:["минуту","минуты","минут"],month:["месяц","месяца","месяцев"],post:["пост","поста","постов"],year:["год","года","лет"]},time:{calendar:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],week:["Вск","Пнд","Втр","Срд","Чтв","Птн","Сбт"]},ui:{send:"Отправить",attach:"Прикрепить",replies:"Ответы",mustMatch:"Пароли должны совпадать",invalidCaptcha:"Неверная капча",quoted:"Вас процитировали",refresh:"Обновить",sessionExpired:"Сессия истекла",thumbnailing:"Генерация превью…",unfinishedPost:"У вас есть незавершённый пост",uploadProgress:"загрузка…",last:"Последние",finished:"Завершено",confirmDelete:"Удалить все посты с этого IP?"}}},e.default=t}),define("cc-templates",["exports"],function(e){var t={};t["post-backlinks"]='<span class="post-backlink-pre">{{ LReplies }}:</span>{{#Backlinks}}<span class="post-backlink">{{{.}}}</span>{{/Backlinks}}',t["post-file"]='<figure class="post-file{{#Record}} post-file_record{{/Record}}"><figcaption class="post-file-info">{{^Record}}<span class="post-file-info-item post-file-dims">{{ Width }}×{{ Height }}</span>{{/Record}}<span class="post-file-info-item post-file-size">{{ Size }}</span>{{#HasLength}}<span class="post-file-info-item post-file-length">{{ Length }}</span>{{/HasLength}}{{#HasTitle}}<span class="post-file-info-item post-file-title" title="{{ Title }} ({{ LCopy }})">{{ Title }}</span>{{/HasTitle}}</figcaption><a class="post-file-link" href="{{ SourcePath }}" target="_blank">{{^Record}} {{#HasVideo}}<i class="fa fa-play-circle-o post-file-badge post-file-video-badge"></i>{{/HasVideo}}{{#HasAudio}}<i class="fa fa-volume-up post-file-badge post-file-audio-badge"></i>{{/HasAudio}} <img class="post-file-thumb{{^HasVideo}} trigger-media-hover{{/HasVideo}} trigger-media-popup" src="{{ ThumbPath }}" width="{{ TWidth }}" height="{{ THeight }}" data-sha1="{{ SHA1 }}"> {{/Record}}{{#Record}}<i class="post-file-thumb trigger-media-popup fa fa-music" data-sha1="{{ SHA1 }}"></i>{{/Record}}</a></figure>',t["post-link"]='<a class="post-link" href="{{ URL }}" data-id="{{ ID }}">&gt;&gt;{{ ID }}{{#Cross}} ➡{{/Cross}}{{#Mine}} {{ LYou }}{{/Mine}}</a>',t.post='<article class="{{ PostClass }}" id="post{{ ID }}" data-id="{{ ID }}"><header class="post-header"><a class="post-anchor" name="{{ ID }}"></a>{{#Badge}}<a class="post-header-item post-board" href="/{{ Board }}/">{{ Board }}</a>{{/Badge}}<a class="post-header-item post-id" href="{{ URL }}">#{{ ID }}</a>{{#OP}}<h3 class="post-header-item post-subject">{{ Subject }}</h3>{{/OP}}{{#Staff}}<span class="post-header-item post-staff">## {{ Auth }} ##</span>{{/Staff}}<time class="post-header-item post-time">{{ Time }}</time></header><section class="post-body">{{#HasFiles}}<div class="post-files">{{#Files}}{{{.}}}{{/Files}}</div>{{/HasFiles}}<blockquote class="post-message">{{{Body}}}</blockquote></section><footer class="post-footer"><div class="post-backlinks">{{{Backlinks}}}</div><div class="post-controls"><a class="control post-control post-delete-control trigger-delete-post"><i class="fa fa-remove trigger-delete-post"></i></a><a class="control post-control post-ban-control trigger-ban-by-post"><i class="fa fa-gavel trigger-ban-by-post"></i></a><a class="control post-control post-quote-control trigger-quote-post"><i class="fa fa-reply trigger-quote-post"></i></a></div></footer></article>',e.default=t});
//# sourceMappingURL=maps/app.js.map
